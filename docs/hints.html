<!DOCTYPE html>

<html>
<head>
  <title>hints.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>hints.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>Seek hints in the data about  what is better than what.    </p>
<ol>
<li>Given many unevaluated things, find the mid-point of few evaluated things.</li>
<li>Prune everything below the mid.</li>
<li>Repeat.</li>
<li>Return the surviving best things.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> the <span class="hljs-comment">-- Global config. Built from `the=updateFromCommandLine(about.how)`</span>
<span class="hljs-keyword">local</span> about={
  what = <span class="hljs-string">&quot;Semi-supervised multi-objective optimizer&quot;</span>,
  when = <span class="hljs-string">&quot;(c) 2021, Tim Menzies, unlicense.org&quot;</span>,
  how  = {
    {<span class="hljs-string">&quot;enough&quot;</span>,<span class="hljs-string">&quot;-e&quot;</span>, <span class="hljs-number">.5</span>,                   <span class="hljs-string">&quot;stopping criteria&quot;</span>},
    {<span class="hljs-string">&quot;file&quot;</span>,  <span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&quot;../data/auto93.csv&quot;</span>, <span class="hljs-string">&quot;data file to load&quot;</span>},
    {<span class="hljs-string">&quot;some&quot;</span>,  <span class="hljs-string">&quot;-s&quot;</span>, <span class="hljs-number">4</span>,                    <span class="hljs-string">&quot;samples per generation&quot;</span>},
    {<span class="hljs-string">&quot;seed&quot;</span>,  <span class="hljs-string">&quot;-S&quot;</span>, <span class="hljs-number">937162211</span>,            <span class="hljs-string">&quot;random number seed&quot;</span>},
    {<span class="hljs-string">&quot;todo&quot;</span>,  <span class="hljs-string">&quot;-do&quot;</span>, <span class="hljs-string">&quot;help&quot;</span>,              <span class="hljs-string">&quot;start-up action&quot;</span>}}}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="functions">Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p><code>b4</code> is  used at end-of-file to find rogue globals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=v <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <h3 id="useful-short-cuts">Useful short cuts</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-built_in">abs</span>,<span class="hljs-built_in">log</span>,cat,fmt,pop,push,<span class="hljs-built_in">sort</span>,same
<span class="hljs-built_in">abs</span>  = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>
cat  = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>
fmt  = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
<span class="hljs-built_in">log</span>  = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span> 
pop  = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">remove</span>
push = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>
same = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x,...)</span></span> <span class="hljs-keyword">return</span> x  <span class="hljs-keyword">end</span>
<span class="hljs-built_in">sort</span> = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h3 id="randoms">Randoms</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Seed, randi, rand
Seed=<span class="hljs-number">937162211</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Random ints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randi</span><span class="hljs-params">(lo,hi)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(<span class="hljs-number">0.5</span> + rand(lo,hi)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Random floats (defaults  0..1)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rand</span><span class="hljs-params">(lo,hi,     mult,mod)</span></span>
  lo, hi = lo <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, hi <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  Seed = (<span class="hljs-number">16807</span> * Seed) % <span class="hljs-number">2147483647</span> 
  <span class="hljs-keyword">return</span> lo + (hi-lo) * Seed / <span class="hljs-number">2147483647</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h3 id="arrays">Arrays</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> firsts,map,keys,shuffle,copy,sum</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Shallow copy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> map(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p><code>firsts</code> is used for sorting {{score1,x1}, {score2,x2},â€¦}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firsts</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> x[<span class="hljs-number">1</span>] &lt; y[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Sorted table keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">keys</span><span class="hljs-params">(t,  u)</span></span> 
  u={};<span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)~=<span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">then</span> push(u,k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(u) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Call <code>f(key,value)</code> on all items  in list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f,  u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[k]=f(k,v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Randomly sort in-place a list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(t,n,    j)</span></span>
  <span class="hljs-keyword">for</span> i = #t,<span class="hljs-number">2</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> j=randi(<span class="hljs-number">1</span>,i); t[i],t[j] = t[j],t[i] <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Sum items in a list, optionally filtered via  <code>f</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sum</span><span class="hljs-params">(t,f,    n)</span></span>
  n,f = <span class="hljs-number">0</span>,f <span class="hljs-keyword">or</span> same
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> n=n+f(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h3 id="command-line">Command-line</h3>
<p>At start-up, <code>the</code>  settings will come from <code>the = cli(about.how)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFromCommandLine</span><span class="hljs-params">(options,   u)</span></span>
  u={}
  <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(options) <span class="hljs-keyword">do</span>
    u[t[<span class="hljs-number">1</span>]] = t[<span class="hljs-number">3</span>]
    <span class="hljs-keyword">for</span> n,word <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> word==t[<span class="hljs-number">2</span>] <span class="hljs-keyword">then</span>
      u[t[<span class="hljs-number">1</span>]] = (t[<span class="hljs-number">3</span>]==<span class="hljs-literal">false</span>) <span class="hljs-keyword">and</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(<span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>]) <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <h3 id="printing">Printing</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> shout,out</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Generate  a pretty-print string from a table (recursively).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">out</span><span class="hljs-params">(t,    u,f1,f2)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f1</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,x,out(t[x])) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f2</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> out(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  u = #t==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> map(keys(t),f1) <span class="hljs-keyword">or</span> map(t,f2)
  <span class="hljs-keyword">return</span> (t._is <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..cat(u,<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Print a pretty-print string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shout</span><span class="hljs-params">(x)</span></span> <span class="hljs-built_in">print</span>(out(x)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <h3 id="csv-reading">CSV reading</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(file,      split,stream,tmp)</span></span>
  stream = file <span class="hljs-keyword">and</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(file) <span class="hljs-keyword">or</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>()
  tmp    = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(       t)</span></span>
    <span class="hljs-keyword">if</span> tmp <span class="hljs-keyword">then</span>
      t,tmp = {},tmp:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;[\t\r ]*&quot;</span>,<span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;#.*&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)
      <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">gmatch</span>(tmp, <span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span> push(t,y) <span class="hljs-keyword">end</span>
      tmp = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
      <span class="hljs-keyword">if</span>  #t &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> map(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(stream) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <h3 id="meta">Meta</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> has,obj</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Instance  creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">(mt,x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(x,mt) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>Object creation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(s, o)</span></span> o={_is=s, <span class="hljs-built_in">__tostring</span>=out}; o.<span class="hljs-built_in">__index</span>=o; <span class="hljs-keyword">return</span> o <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h2 id="classes">Classes</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
<span class="hljs-keyword">local</span> Sym,Num,Skip,Cols,Sample</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <h3 id="cols">Cols</h3>
<p><code>Cols</code> is a factory for turning  column names into their
rightful columns. Those names contain certain magic symbols.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> klassp,skipp,goalp,nump,ako,weight
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goalp</span><span class="hljs-params">(v)</span></span>  <span class="hljs-keyword">return</span> klassp(v)  <span class="hljs-keyword">or</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;+&quot;</span> <span class="hljs-keyword">or</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">klassp</span><span class="hljs-params">(v)</span></span> <span class="hljs-keyword">return</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nump</span><span class="hljs-params">(v)</span></span>   <span class="hljs-keyword">return</span> v:<span class="hljs-built_in">match</span>(<span class="hljs-string">&quot;^[A-Z]&quot;</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skipp</span><span class="hljs-params">(v)</span></span>  <span class="hljs-keyword">return</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">weight</span><span class="hljs-params">(v)</span></span> <span class="hljs-keyword">return</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;+&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>New columns are either <code>Skip</code>s or <code>Num</code>s or <code>Sym</code>s.
New columns are always stored in <code>all</code> and
independent/dependent columns (that we are not <code>skipp</code>ing)
are stored  in <code>xs</code> or <code>ys</code> respectively.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Cols= obj<span class="hljs-string">&quot;Cols&quot;</span> <span class="hljs-comment">---------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cols.new</span><span class="hljs-params">(lst,       self,now,what)</span></span>
  <span class="hljs-built_in">self</span> = has(Cols, {header=lst,all={},xs={},ys={},klass=<span class="hljs-literal">nil</span>}) 
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(lst) <span class="hljs-keyword">do</span>
    what = (skipp(v) <span class="hljs-keyword">and</span> Skip) <span class="hljs-keyword">or</span> (nump(v) <span class="hljs-keyword">and</span> Num) <span class="hljs-keyword">or</span> Sym 
    now = what.new(k,v)
    push(<span class="hljs-built_in">self</span>.all, now)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> skipp(v) <span class="hljs-keyword">then</span> 
      <span class="hljs-keyword">if</span> klassp(v) <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.klass=now <span class="hljs-keyword">end</span>
      push(goalp(v) <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.ys <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.xs, now) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <h3 id="sym">Sym</h3>
<p>Columns for summarizing <code>Sym</code>bols.
Columns have a similar set of methods:   </p>
<ol>
<li><code>add(x)</code> increments <code>self</code> with <code>x</code>;</li>
<li><code>dist(x,y)</code> between two items <code>x</code> and <code>y</code>;</li>
<li><code>mid()</code> returns the central tendency;</li>
<li><code>spread()</code> returns the variability around the <code>mid</code>.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>Sym = obj<span class="hljs-string">&quot;Sym&quot;</span> <span class="hljs-comment">----------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym.new</span><span class="hljs-params">(i,s)</span></span> <span class="hljs-keyword">return</span> has(Sym, {at=i,txt=s,n=<span class="hljs-number">0</span>,seen={},mode=<span class="hljs-literal">nil</span>,most=<span class="hljs-number">0</span>}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:add</span><span class="hljs-params">(x)</span></span>    
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>; 
  <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
  <span class="hljs-built_in">self</span>.seen[x] = <span class="hljs-number">1</span>+(<span class="hljs-built_in">self</span>.seen[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.seen[x] &gt; <span class="hljs-built_in">self</span>.most <span class="hljs-keyword">then</span> 
     <span class="hljs-built_in">self</span>.most,<span class="hljs-built_in">self</span>.mode = <span class="hljs-built_in">self</span>.seen[x],x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:dist</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span>  x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:mid</span><span class="hljs-params">()</span></span>     <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mode <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:spread</span><span class="hljs-params">()</span></span>  <span class="hljs-comment">-- entropy</span>
  <span class="hljs-keyword">return</span> sum(<span class="hljs-built_in">self</span>.seen, 
             <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span> <span class="hljs-keyword">return</span> n&lt;<span class="hljs-number">-0</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> -n/<span class="hljs-built_in">self</span>.n*<span class="hljs-built_in">log</span>(n/<span class="hljs-built_in">self</span>.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <h3 id="num">Num</h3>
<p>Columns for sumamrizing numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Num = obj<span class="hljs-string">&quot;Num&quot;</span> <span class="hljs-comment">----------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num.new</span><span class="hljs-params">(i,s)</span></span> 
  <span class="hljs-keyword">return</span> has(Num,{at=i,txt=s, n=<span class="hljs-number">0</span>,_contents={}, ok=<span class="hljs-literal">false</span>,w=weight(s)}) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:add</span><span class="hljs-params">(x)</span></span> 
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
  push(<span class="hljs-built_in">self</span>._contents, x)
  <span class="hljs-built_in">self</span>.ok = <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span> <span class="hljs-comment">-- note: the updated contents are no longer sorted</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Ensure the contents are shorted; them return those concents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:all</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.ok <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">true</span>; <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>._contents) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>._contents <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>If either of <code>x,y</code> is unknown, guess a value that maximizes the distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:dist</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> y = <span class="hljs-built_in">self</span>:norm(x); x = y&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span>  <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> x = <span class="hljs-built_in">self</span>:norm(x); y = x&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span>  <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">else</span>   x,y = <span class="hljs-built_in">self</span>:norm(x), <span class="hljs-built_in">self</span>:norm(y)  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:mid</span><span class="hljs-params">(    a)</span></span> a=<span class="hljs-built_in">self</span>:all(); <span class="hljs-keyword">return</span> a[#a//<span class="hljs-number">2</span>] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:norm</span><span class="hljs-params">(x,     a)</span></span>
  a=<span class="hljs-built_in">self</span>:all()
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(a[#a]-a[<span class="hljs-number">1</span>])&lt; <span class="hljs-number">1E-16</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x - a[<span class="hljs-number">1</span>])/(a[#a] - a[<span class="hljs-number">1</span>]) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>The standard deviation of a list of sorted numbers  is the
90th - 10th percentile, divided by 2.56. Why? It is widely
know that &plusmn; 1 to 2 standard deviations is 66 to 95% 
of the probability. Well, it is also true that
&plusmn; is 1.28 is 90% of the mass which, to say that 
another way, one standard deviation is 2*1.28 of &plusmn; 90%.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:spread</span><span class="hljs-params">(   a,here)</span></span> 
  a = <span class="hljs-built_in">self</span>:all() 
  <span class="hljs-keyword">if</span> #a &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">here</span><span class="hljs-params">(x)</span></span> x=x*#a//<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> x &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> x&gt;#a <span class="hljs-keyword">and</span> #a <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (a[here(<span class="hljs-number">.9</span>)] - a[here(<span class="hljs-number">.1</span>)])/<span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <h3 id="skip">Skip</h3>
<p>Columns for data we are skipping over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Skip= obj<span class="hljs-string">&quot;Skip&quot;</span> <span class="hljs-comment">---------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Skip.new</span><span class="hljs-params">(i,s)</span></span> <span class="hljs-keyword">return</span> has(Skip,{at=i,txt=s}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Skip:add</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Skip:mid</span><span class="hljs-params">()</span></span>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Skip:spread</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <h3 id="sample">Sample</h3>
<p>A <code>Sample</code> of data stores <code>rows</code>, summarized into <code>Col</code>umns.
If <code>src</code> is provided, the use it for initialization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Sample= obj<span class="hljs-string">&quot;Sample&quot;</span> <span class="hljs-comment">-----------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample.new</span><span class="hljs-params">(src,   self)</span></span> 
  <span class="hljs-built_in">self</span> = has(Sample, {rows={}, cols=<span class="hljs-literal">nil</span>}) 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span>   row <span class="hljs-keyword">in</span> csv(src)   <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;table&quot;</span>  <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>If <code>self.cols</code> is missing, then <code>lst</code> is the row of column names.
Else, update the columns using the  data in <code>lst</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">Sample:add</span><span class="hljs-params">(lst,   add)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span><span class="hljs-params">(k,v)</span></span> <span class="hljs-built_in">self</span>.cols.all[k]:add(v); <span class="hljs-keyword">return</span> v; <span class="hljs-keyword">end</span>  
  <span class="hljs-keyword">if</span>   <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.cols <span class="hljs-comment">-- then  `lst` is  the  header row</span>
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.cols = Cols.new(lst) 
  <span class="hljs-keyword">else</span> push(<span class="hljs-built_in">self</span>.rows, map(lst,add)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>The Zitler domination predicate. <code>Row1</code> is better
than <code>row2</code> if the average loss less moving from <code>row1</code> to <code>row2</code>
is less than the other way around. To see the loss to full effect,
raise any delta to some exponential power.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:better</span><span class="hljs-params">(row1,row2,cols)</span></span>
  <span class="hljs-keyword">local</span> n,a,b,s1,s2
  cols = cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.ys
  s1, s2, n = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, #cols
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span>
    a  = col:norm(row1[col.at]) <span class="hljs-comment">--normalize to avoid explosion in exponentiation</span>
    b  = col:norm(row2[col.at])
    s1 = s1 - <span class="hljs-number">10</span>^(col.w * (a - b) / n)
    s2 = s2 - <span class="hljs-number">10</span>^(col.w * (b - a) / n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1 / n &lt; s2 / n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>Return a new <code>Sample</code> with the same structure as this one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:clone</span><span class="hljs-params">(inits,   now)</span></span>
  now = Sample.new()
  now:add(<span class="hljs-built_in">self</span>.cols.header)
  map(inits <span class="hljs-keyword">or</span> {}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,row)</span></span> now:add(row) <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">return</span> now <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p>Two samples are different if any of their goals are more than
(say) .35* the standard devation of that goal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:diff</span><span class="hljs-params">(other, cols,  y)</span></span>
  cols = cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.ys
  n1,m1,s1= #<span class="hljs-built_in">self</span>.rows,  <span class="hljs-built_in">self</span>:mid(cols),  <span class="hljs-built_in">self</span>:spread(cols)
  n2,m2,s2= #other.rows, other:mid(cols), other:spread(cols)
  <span class="hljs-keyword">for</span> i,y1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(m1) <span class="hljs-keyword">do</span>
    y2 = m2[i]
    <span class="hljs-keyword">if</span>   <span class="hljs-built_in">abs</span>(y1-y2) &gt; the.cohen*(s1[i]*n1/(n1+n2) + s2[i]*n2/(n1+n2)) 
    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <p>Distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:dist</span><span class="hljs-params">(row1,row2)</span></span>
  <span class="hljs-keyword">local</span> d,n,p,x,y,inc
  d, n, p = <span class="hljs-number">0</span>, <span class="hljs-number">1E-32</span>, <span class="hljs-number">2</span>
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.cols.xs) <span class="hljs-keyword">do</span>
    x,y = row1[col.at], row2[col.at]
    inc = (x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">or</span> col:dist(x,y)
    d   = d + inc^p 
    n   = n + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/n)^(<span class="hljs-number">1</span>/p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p>And finally, we can do the inference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:div</span><span class="hljs-params">()</span></span>
  <span class="hljs-keyword">local</span> better,want,go,somes
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">better</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:better(x,y) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">want</span><span class="hljs-params">(_,row)</span></span>
    <span class="hljs-keyword">local</span> closest,rowRank,tmp = <span class="hljs-number">1E32</span>,<span class="hljs-number">1E32</span>,<span class="hljs-literal">nil</span>
    <span class="hljs-keyword">for</span> someRank,some1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(somes) <span class="hljs-keyword">do</span>
       tmp = <span class="hljs-built_in">self</span>:dist(row,some1)
       <span class="hljs-keyword">if</span> tmp &lt; closest <span class="hljs-keyword">then</span> closest,rowRank = tmp,someRank <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> {rowRank,row}
  <span class="hljs-keyword">end</span> <span class="hljs-comment">------------------</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go</span><span class="hljs-params">(stop,rows,     best)</span></span>
    <span class="hljs-keyword">if</span> #rows &lt; stop <span class="hljs-keyword">or</span> #rows &lt; the.some <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>,the.some <span class="hljs-keyword">do</span> push(somes,pop(rows)) <span class="hljs-keyword">end</span>
    somes = <span class="hljs-built_in">sort</span>(somes, better)
    best = {}
    <span class="hljs-keyword">for</span> i,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(map(rows,want),firsts)) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> i &lt;= #rows//<span class="hljs-number">2</span> <span class="hljs-keyword">then</span> push(best,row[<span class="hljs-number">2</span>]) <span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> go(stop, best) 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">---------------------------------------------------</span>
  somes={}
  <span class="hljs-keyword">return</span> go((#<span class="hljs-built_in">self</span>.rows)^the.enough, shuffle(copy(<span class="hljs-built_in">self</span>.rows))) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p>The central tendency of a <code>sample</code> comes fro its columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:mid</span><span class="hljs-params">(  cols)</span></span> 
  <span class="hljs-keyword">return</span> map(cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.all, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,x)</span></span>  <span class="hljs-keyword">return</span> x:mid() <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p>The spread of a <code>sample</code> comes fro its columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:spread</span><span class="hljs-params">(   cols)</span></span> 
  <span class="hljs-keyword">return</span> map(cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.all, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> x:spread() <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h2 id="stuff-todo-at-start-up">Stuff <code>Todo</code> at Start-up</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Todo={} <span class="hljs-comment">------------------------------------------------------------------</span>
Todo.help={<span class="hljs-string">&quot;print help&quot;</span>, 
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;lua hints.lua [OPTIONS] -do ACTION\n&quot;</span>)
    <span class="hljs-built_in">print</span>(about.what)
    <span class="hljs-built_in">print</span>(about.when,<span class="hljs-string">&quot;\n\nOPTIONS:&quot;</span>);
    <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(about.how) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> t[<span class="hljs-number">1</span>] ~= <span class="hljs-string">&quot;todo&quot;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;  %-4s%-20s %s&quot;</span>,
                t[<span class="hljs-number">2</span>], t[<span class="hljs-number">3</span>]==<span class="hljs-literal">false</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">or</span> t[<span class="hljs-number">3</span>], t[<span class="hljs-number">4</span>])) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nACTIONS:&quot;</span>)
    <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(keys(Todo)) <span class="hljs-keyword">do</span>
      <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;  -do %-21s%s&quot;</span>,k, Todo[k][<span class="hljs-number">1</span>])) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>}

Todo.demo1={<span class="hljs-string">&quot;main demo&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(     s,t,u)</span></span>
  s = Sample.new(the.file)
  <span class="hljs-built_in">print</span>(#s.rows, out(s:mid(s.cols.ys)), out(s:spread(s.cols.ys)))
  <span class="hljs-keyword">for</span> _=<span class="hljs-number">1</span>,<span class="hljs-number">40</span> <span class="hljs-keyword">do</span>
    t = Sample.new(the.file)
    u = t:clone( t:div() ) 
    <span class="hljs-built_in">print</span>(#u.rows, out(u:mid(u.cols.ys)), out(u:spread(u.cols.ys))) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>}

the  = updateFromCommandLine(about.how)
Seed = the.seed
Todo[the.todo][<span class="hljs-number">2</span>]()</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p>Check for rogue globals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;? &quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
