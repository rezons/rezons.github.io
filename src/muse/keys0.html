<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>keys0</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="lua.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">keys0</h1>
</header>
<div class="sourceCode" id="cb1"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> your <span class="op">=</span> <span class="op">{}</span> <span class="co">-- user settings (may be changes from command-line)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> our  <span class="op">=</span> <span class="op">{}</span> <span class="co">-- system settings (controlled internal to code)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>help   <span class="op">=</span> <span class="vs">[[</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="vs">         </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="vs">./keys0 [OPTIONS]</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="vs">Understand &quot;N&quot; items by peeking at at few (maybe zero) items.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="vs">(c) 2022, Tim Menzies, opensource.org/licenses/MIT</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="vs">       </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  -ample  max items in a &#39;SAMPLE&#39;       : 512</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  -better prune best half of each split : true</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  -Debug  one crash, show stackdump     : true</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  -dull   small effect if &#39;dull&#39;*sd     : .35</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="vs">  -far    for far,  skip after &#39;far&#39;    : .9</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="vs">  -file   load data from file           : ../../data/auto93.csv</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="vs">  -h      show help                     : false</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="vs">  -goal   smile,frown,xplor, doubt      : smile</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="vs">  -p      coefficient on distance calcs : 2</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="vs">  -round  round numbers to &#39;round&#39;      : 2</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="vs">  -seed   random number seed            : 10019</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="vs">  -Some   max number items to explore   : 512</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  -Tiny   bin size = #t^&#39;Tiny&#39;          : .5</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="vs">  -todo   start up action (&#39;all&#39;=every) : -]]</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>b4<span class="op">={}</span>       <span class="co">-- globals known, pre-code. used to find stray globals</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k<span class="op">,</span><span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">_ENV</span><span class="op">)</span> <span class="cf">do</span> our<span class="op">.</span>b4<span class="op">[</span>k<span class="op">]=</span>k <span class="cf">end</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> add<span class="op">,</span> any<span class="op">,</span> asserts<span class="op">,</span>coerce<span class="op">,</span> col<span class="op">,</span> copy<span class="op">,</span> csv<span class="op">,</span> dist </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> firsts<span class="op">,</span> fmt<span class="op">,</span> klass<span class="op">,</span> map<span class="op">,</span> main<span class="op">,</span> new<span class="op">,</span>o<span class="op">,</span> push<span class="op">,</span> rand<span class="op">,</span> randi<span class="op">,</span> rnd<span class="op">,</span> rnds</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> same<span class="op">,</span> seconds<span class="op">,</span> slots<span class="op">,</span> sort<span class="op">,</span> userSettings<span class="op">,</span> xpects</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> klass<span class="op">(</span>s<span class="op">,</span> it<span class="op">)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  it <span class="op">=</span> <span class="op">{</span><span class="cn">_</span>is<span class="op">=</span>s<span class="op">,</span> <span class="bu">__tostring</span><span class="op">=</span>o<span class="op">}</span> </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  it<span class="op">.</span><span class="cn">__</span>index <span class="op">=</span> it</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">setmetatable</span><span class="op">(</span>it<span class="op">,{</span><span class="bu">__call</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="cn">_</span><span class="op">,...)</span> <span class="cf">return</span> it<span class="op">.</span>new<span class="op">(...)</span> <span class="kw">end</span><span class="op">})</span> <span class="kw">end</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">COLS</span><span class="op">,</span><span class="cn">EG</span><span class="op">,</span><span class="cn">EGS</span>   <span class="op">=</span> klass<span class="st">&quot;COLS&quot;</span><span class="op">,</span> klass<span class="st">&quot;EG&quot;</span><span class="op">,</span> klass<span class="st">&quot;EGS&quot;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">NUM</span><span class="op">,</span><span class="cn">RANGE</span><span class="op">,</span><span class="cn">SAMPLE</span><span class="op">,</span><span class="cn">SYM</span> <span class="op">=</span> klass<span class="st">&quot;NUM&quot;</span><span class="op">,</span> klass<span class="st">&quot;RANGE&quot;</span><span class="op">,</span> klass<span class="st">&quot;SAMPLE&quot;</span><span class="op">,</span> klass<span class="st">&quot;SYM&quot;</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb2"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">SAMPLE</span><span class="op">=</span>klass<span class="st">&quot;SAMPLE&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SAMPLE</span><span class="op">.</span>new<span class="op">()</span> <span class="cf">return</span> new<span class="op">(</span><span class="cn">SAMPLE</span><span class="op">,{</span>n<span class="op">=</span><span class="dv">0</span><span class="op">,</span> all<span class="op">={},</span> max<span class="op">=</span>your<span class="op">.</span>ample<span class="op">})</span> <span class="kw">end</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SAMPLE</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>     pos<span class="op">)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>n<span class="op">=</span> i<span class="op">.</span>n <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>     <span class="op">#</span>i<span class="op">.</span>all <span class="op">&lt;</span> i<span class="op">.</span>max      <span class="cf">then</span> pos<span class="op">=</span> <span class="op">#</span>i<span class="op">.</span>all <span class="op">+</span> <span class="dv">1</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elseif</span> rand<span class="op">()</span> <span class="op">&lt;</span> <span class="op">#</span>i<span class="op">.</span>all<span class="op">/</span>i<span class="op">.</span>n <span class="cf">then</span> pos<span class="op">=</span> <span class="op">#</span>i<span class="op">.</span>all <span class="op">*</span> rand<span class="op">()</span> <span class="cf">end</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> pos <span class="cf">then</span> i<span class="op">.</span>all<span class="op">[</span>pos<span class="op">//</span><span class="dv">1</span><span class="op">]=</span> x <span class="cf">end</span> <span class="kw">end</span> </span></code></pre></div>
<hr />
<div class="sourceCode" id="cb3"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>new<span class="op">(</span>at<span class="op">,</span>s<span class="op">,</span>   i<span class="op">)</span>  </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  i<span class="op">=</span> new<span class="op">(</span><span class="cn">NUM</span><span class="op">,{</span>n<span class="op">=</span><span class="dv">0</span><span class="op">,</span>at<span class="op">=</span>at <span class="kw">or</span> <span class="dv">0</span><span class="op">,</span> txt<span class="op">=</span>s <span class="kw">or</span> <span class="st">&quot;&quot;</span><span class="op">,</span><span class="cn">_</span>has<span class="op">=</span>SAMPLE<span class="op">(),</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>              mu<span class="op">=</span><span class="dv">0</span><span class="op">,</span>m2<span class="op">=</span><span class="dv">0</span><span class="op">,</span>lo<span class="op">=</span><span class="fu">math.huge</span><span class="op">,</span>hi<span class="op">=-</span><span class="fu">math.huge</span><span class="op">})</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>w <span class="op">=</span> i<span class="op">.</span>txt<span class="op">:</span><span class="fu">find</span><span class="st">&quot;-&quot;</span> <span class="kw">and</span> <span class="op">-</span><span class="dv">1</span> <span class="kw">or</span> <span class="dv">1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> i <span class="kw">end</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>  d<span class="op">)</span>  </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> x<span class="op">~=</span><span class="st">&quot;?&quot;</span> <span class="cf">then</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span>n  <span class="op">=</span> i<span class="op">.</span>n <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    d    <span class="op">=</span> x    <span class="op">-</span> i<span class="op">.</span>mu</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span>mu <span class="op">=</span> i<span class="op">.</span>mu <span class="op">+</span> d<span class="op">/</span>i<span class="op">.</span>n</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span>m2 <span class="op">=</span> i<span class="op">.</span>m2 <span class="op">+</span> d<span class="op">*(</span>x<span class="op">-</span>i<span class="op">.</span>mu<span class="op">)</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span><span class="cn">_</span>has<span class="op">:</span>add<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span>lo <span class="op">=</span> <span class="fu">math.min</span><span class="op">(</span>i<span class="op">.</span>lo<span class="op">,</span>x<span class="op">);</span> i<span class="op">.</span>hi <span class="op">=</span> <span class="fu">math.max</span><span class="op">(</span>i<span class="op">.</span>hi<span class="op">,</span>x<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="kw">end</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>dist<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>y<span class="op">)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>     x<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="kw">and</span> y<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="cf">then</span> <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elseif</span> x<span class="op">==</span><span class="st">&quot;?&quot;</span>            <span class="cf">then</span> y<span class="op">=</span> i<span class="op">:</span>norm<span class="op">(</span>y<span class="op">);</span> x<span class="op">=</span>y<span class="op">&gt;</span><span class="dv">.5</span> <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> <span class="dv">1</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elseif</span> y<span class="op">==</span><span class="st">&quot;?&quot;</span>            <span class="cf">then</span> x<span class="op">=</span> i<span class="op">:</span>norm<span class="op">(</span>x<span class="op">);</span> y<span class="op">=</span>x<span class="op">&gt;</span><span class="dv">.5</span> <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> <span class="dv">1</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>   x<span class="op">,</span>y <span class="op">=</span> i<span class="op">:</span>norm<span class="op">(</span>x<span class="op">),</span> i<span class="op">:</span>norm<span class="op">(</span>y<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">math.abs</span><span class="op">(</span>x<span class="op">-</span>y<span class="op">)</span> <span class="kw">end</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>div<span class="op">(</span>i<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>n<span class="op">&lt;</span><span class="dv">2</span> <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> <span class="op">(</span>i<span class="op">.</span>m2<span class="op">/(</span>i<span class="op">.</span>n<span class="op">-</span><span class="dv">1</span><span class="op">))^</span><span class="dv">0.5</span> <span class="kw">end</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>merged<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  k<span class="op">=</span> NUM<span class="op">(</span>i<span class="op">.</span>at<span class="op">,</span> i<span class="op">.</span>txt<span class="op">)</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>x <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span><span class="cn">_</span>has<span class="op">,</span>all<span class="op">)</span> <span class="cf">do</span> k<span class="op">:</span>add<span class="op">(</span>x<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>x <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>j<span class="op">.</span><span class="cn">_</span>has<span class="op">.</span>akk<span class="op">)</span> <span class="cf">do</span> k<span class="op">:</span>add<span class="op">(</span>x<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> k <span class="kw">end</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>mid<span class="op">(</span>i<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>mu <span class="kw">end</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>norm<span class="op">(</span>i<span class="op">,</span>x<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>hi<span class="op">-</span>i<span class="op">.</span>lo<span class="op">&lt;</span><span class="dv">1E-9</span> <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> <span class="op">(</span>x<span class="op">-</span>i<span class="op">.</span>lo<span class="op">)/(</span>i<span class="op">.</span>hi<span class="op">-</span>i<span class="op">.</span>lo<span class="op">)</span> <span class="kw">end</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>ranges<span class="op">(</span>i<span class="op">,</span>j<span class="op">,</span> yklass<span class="op">)</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> xys<span class="op">,</span> dull<span class="op">,</span> tiny<span class="op">,</span> range<span class="op">,</span>out</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  yklass <span class="op">=</span> yklass <span class="kw">or</span> <span class="cn">SYM</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  xys    <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>x <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span><span class="cn">_</span>has<span class="op">.</span>all<span class="op">)</span> <span class="cf">do</span> push<span class="op">(</span>xys<span class="op">,</span> <span class="op">{</span>x<span class="op">=</span>x<span class="op">,</span> y<span class="op">=</span><span class="st">&quot;best&quot;</span><span class="op">})</span> <span class="cf">end</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>x <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>j<span class="op">,</span><span class="cn">_</span>has<span class="op">.</span>all<span class="op">)</span> <span class="cf">do</span> push<span class="op">(</span>xys<span class="op">,</span> <span class="op">{</span>x<span class="op">=</span>x<span class="op">,</span> y<span class="op">=</span><span class="st">&quot;rest&quot;</span><span class="op">})</span> <span class="cf">end</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  xys    <span class="op">=</span> <span class="fu">sort</span><span class="op">(</span>xys<span class="op">,</span> <span class="kw">function</span><span class="op">(</span>a<span class="op">,</span>b<span class="op">)</span> <span class="cf">return</span> a<span class="op">.</span>x <span class="op">&lt;</span> b<span class="op">.</span>x <span class="kw">end</span><span class="op">)</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  dull   <span class="op">=</span> xpects<span class="op">{</span>i<span class="op">,</span>j<span class="op">}*</span>your<span class="op">.</span>dull</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  tiny   <span class="op">=</span> <span class="op">(#</span>xys<span class="op">)^</span>your<span class="op">.</span><span class="cn">T</span>iny </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  range  <span class="op">=</span> RANGE<span class="op">(</span>i<span class="op">,</span>xys<span class="op">[</span><span class="dv">1</span><span class="op">].</span>x<span class="op">,</span> xys<span class="op">[</span><span class="dv">1</span><span class="op">].</span>x<span class="op">,</span> yklass<span class="op">())</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  out <span class="op">=</span> <span class="op">{</span>range<span class="op">}</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> k<span class="op">,</span>xy <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>xys<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>   k <span class="op">&lt;</span> <span class="op">#</span>xys <span class="op">-</span> tiny    <span class="kw">and</span> xy<span class="op">.</span>x <span class="op">~=</span> xys<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">].</span>x <span class="kw">and</span> </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>         range<span class="op">.</span>has<span class="op">.</span>n <span class="op">&gt;</span> tiny <span class="kw">and</span> range<span class="op">.</span>hi <span class="op">-</span> range<span class="op">.</span>lo <span class="op">&gt;</span> dull</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">then</span> range <span class="op">=</span> push<span class="op">(</span>out<span class="op">,</span> RANGE<span class="op">(</span>i<span class="op">,</span> range<span class="op">.</span>hi<span class="op">,</span> xy<span class="op">.</span>x<span class="op">,</span> yklass<span class="op">()))</span> </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    range<span class="op">:</span>add<span class="op">(</span>xy<span class="op">.</span>x<span class="op">,</span> xy<span class="op">.</span>y<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  out<span class="op">[</span><span class="dv">1</span><span class="op">].</span>lo       <span class="op">=</span> <span class="op">-</span><span class="fu">math.huge</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  out<span class="op">[#</span>ranges<span class="op">].</span>hi <span class="op">=</span>  <span class="fu">math.huge</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out <span class="kw">end</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">NUM</span><span class="op">.</span>superRanges<span class="op">(</span>i<span class="op">,</span>b4<span class="op">)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> j<span class="op">,</span>tmp<span class="op">,</span>now<span class="op">,</span>after<span class="op">,</span>maybe <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="op">{}</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> j <span class="op">&lt;</span> <span class="op">#</span>b4 <span class="cf">do</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    j <span class="op">=</span> j <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    now<span class="op">,</span> after <span class="op">=</span> b4<span class="op">[</span>j<span class="op">],</span> b4<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> after <span class="cf">then</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>      maybe <span class="op">=</span> now<span class="op">:</span>merge<span class="op">(</span>after<span class="op">)</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> maybe <span class="cf">then</span> now<span class="op">=</span>maybe<span class="op">;</span> j<span class="op">=</span>j<span class="op">+</span><span class="dv">1</span> <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span>tmp<span class="op">,</span>now<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">#</span>tmp<span class="op">==#</span>b4 <span class="kw">and</span> b4 <span class="kw">or</span> i<span class="op">:</span>superRanges<span class="op">(</span>tmp<span class="op">)</span> <span class="kw">end</span> </span></code></pre></div>
<hr />
<div class="sourceCode" id="cb4"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>new<span class="op">(</span>at<span class="op">,</span>s<span class="op">)</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> new<span class="op">(</span><span class="cn">SYM</span><span class="op">,{</span>n<span class="op">=</span><span class="dv">0</span><span class="op">,</span> at<span class="op">=</span>at <span class="kw">or</span> <span class="dv">0</span><span class="op">,</span> txt<span class="op">=</span>s <span class="kw">or</span> <span class="st">&quot;&quot;</span><span class="op">,</span> has<span class="op">={},</span> most<span class="op">=</span><span class="dv">0</span><span class="op">,</span> mode<span class="op">=</span><span class="kw">nil</span><span class="op">})</span> <span class="kw">end</span> </span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>count<span class="op">)</span>   </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  count <span class="op">=</span> count <span class="kw">or</span> <span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>has<span class="op">[</span>x<span class="op">]</span> <span class="op">=</span> count <span class="op">+</span> <span class="op">(</span>i<span class="op">.</span>has<span class="op">[</span>x<span class="op">]</span> <span class="kw">or</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i<span class="op">.</span>has<span class="op">[</span>x<span class="op">]</span> <span class="op">&gt;</span> i<span class="op">.</span>most <span class="cf">then</span> i<span class="op">.</span>most<span class="op">,</span>i<span class="op">.</span>mode <span class="op">=</span> i<span class="op">.</span>has<span class="op">[</span>x<span class="op">],</span> x <span class="cf">end</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>dist<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>y<span class="op">)</span> <span class="cf">return</span> x<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="kw">and</span> y<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="kw">and</span> <span class="dv">1</span> <span class="kw">or</span> x<span class="op">==</span>y <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> <span class="dv">1</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>div<span class="op">(</span>i<span class="op">,</span>   e<span class="op">)</span>  </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  e<span class="op">=</span><span class="dv">0</span><span class="op">;</span> <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>n <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span> e<span class="op">=</span>e<span class="op">-</span>n<span class="op">/</span>i<span class="op">.</span>n<span class="op">*</span><span class="fu">math.log</span><span class="op">(</span>n<span class="op">/</span>i<span class="op">.</span>n<span class="op">,</span><span class="dv">2</span><span class="op">)</span> <span class="cf">end</span><span class="op">;</span> <span class="cf">return</span> e <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>merged<span class="op">(</span>i<span class="op">,</span>j<span class="op">,</span>     k<span class="op">)</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  k<span class="op">=</span> SYM<span class="op">(</span>i<span class="op">.</span>at<span class="op">,</span> i<span class="op">.</span>txt<span class="op">)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x<span class="op">,</span>count <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span> k<span class="op">:</span>add<span class="op">(</span>x<span class="op">,</span>count<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x<span class="op">,</span>count <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>j<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span> k<span class="op">:</span>add<span class="op">(</span>x<span class="op">,</span>count<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> k <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>mid<span class="op">(</span>i<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>mode <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>ranges<span class="op">(</span>i<span class="op">,</span>j<span class="op">,</span>        ranges<span class="op">,</span>t<span class="op">,</span>n<span class="op">,</span>xpect<span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  t<span class="op">,</span>out <span class="op">=</span> <span class="op">{},{}</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x<span class="op">,</span>n <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span> t<span class="op">[</span>x<span class="op">]=</span> t<span class="op">[</span>x<span class="op">]</span> <span class="kw">or</span> SYM<span class="op">();</span> t<span class="op">[</span>x<span class="op">]:</span>add<span class="op">(</span><span class="st">&quot;best&quot;</span><span class="op">,</span>n<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x<span class="op">,</span>n <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>j<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span> t<span class="op">[</span>x<span class="op">]=</span> t<span class="op">[</span>x<span class="op">]</span> <span class="kw">or</span> SYM<span class="op">();</span> t<span class="op">[</span>x<span class="op">]:</span>add<span class="op">(</span><span class="st">&quot;rest&quot;</span><span class="op">,</span>n<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x<span class="op">,</span>stats <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> push<span class="op">(</span>out<span class="op">,</span> RANGE<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>x<span class="op">,</span>stats<span class="op">))</span> <span class="cf">end</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">SYM</span><span class="op">.</span>superRanges<span class="op">(</span>i<span class="op">,</span> ranges<span class="op">)</span> <span class="cf">return</span> ranges <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb12"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EG</span><span class="op">.</span>new<span class="op">(</span>t<span class="op">)</span> <span class="cf">return</span> new<span class="op">(</span><span class="cn">EG</span><span class="op">,</span> <span class="op">{</span>cooked<span class="op">={},</span> has<span class="op">=</span>t<span class="op">})</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EG</span><span class="op">.</span>better<span class="op">(</span>eg1<span class="op">,</span>eg2<span class="op">,</span>egs<span class="op">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> s1<span class="op">,</span>s2<span class="op">,</span>e<span class="op">,</span>n<span class="op">,</span>a<span class="op">,</span>b <span class="op">=</span> <span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">10</span><span class="op">,#</span>egs<span class="op">.</span>cols<span class="op">.</span>y</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>col <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>egs<span class="op">.</span>cols<span class="op">.</span>y<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    a  <span class="op">=</span> col<span class="op">:</span>norm<span class="op">(</span>eg1<span class="op">.</span>has<span class="op">[</span>col<span class="op">.</span>at<span class="op">])</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    b  <span class="op">=</span> col<span class="op">:</span>norm<span class="op">(</span>eg2<span class="op">.</span>has<span class="op">[</span>col<span class="op">.</span>at<span class="op">])</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    s1 <span class="op">=</span> s1 <span class="op">-</span> e<span class="op">^(</span>col<span class="op">.</span>w <span class="op">*</span> <span class="op">(</span>a<span class="op">-</span>b<span class="op">)/</span>n<span class="op">)</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    s2 <span class="op">=</span> s2 <span class="op">-</span> e<span class="op">^(</span>col<span class="op">.</span>w <span class="op">*</span> <span class="op">(</span>b<span class="op">-</span>a<span class="op">)/</span>n<span class="op">)</span> <span class="cf">end</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> s1<span class="op">/</span>n <span class="op">&lt;</span> s2<span class="op">/</span>n <span class="kw">end</span> </span></code></pre></div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EG</span><span class="op">.</span>cols<span class="op">(</span>i<span class="op">,</span>cols<span class="op">)</span> <span class="cf">return</span> map<span class="op">(</span>cols<span class="op">,</span><span class="kw">function</span><span class="op">(</span>x<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>has<span class="op">[</span>x<span class="op">.</span>at<span class="op">]</span> <span class="kw">end</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EG</span><span class="op">.</span>dist<span class="op">(</span>i<span class="op">,</span>j<span class="op">,</span>egs<span class="op">,</span>    a<span class="op">,</span>b<span class="op">,</span>d<span class="op">,</span>n<span class="op">)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  d<span class="op">,</span>n <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="op">#</span>egs<span class="op">.</span>cols<span class="op">.</span>x <span class="op">+</span> <span class="dv">1E-31</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>col <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>egs<span class="op">.</span>cols<span class="op">.</span>x<span class="op">)</span> <span class="cf">do</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    a<span class="op">,</span>b <span class="op">=</span> i<span class="op">.</span>has<span class="op">[</span>col<span class="op">.</span>at<span class="op">],</span> j<span class="op">.</span>has<span class="op">[</span>col<span class="op">.</span>at<span class="op">]</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    d   <span class="op">=</span> d <span class="op">+</span> col<span class="op">:</span>dist<span class="op">(</span>a<span class="op">,</span>b<span class="op">)</span> <span class="op">^</span> your<span class="op">.</span>p <span class="cf">end</span> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>d<span class="op">/</span>n<span class="op">)</span> <span class="op">^</span> <span class="op">(</span><span class="dv">1</span><span class="op">/</span>your<span class="op">.</span>p<span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb16"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>new<span class="op">(</span>col<span class="op">,</span>lo<span class="op">,</span>hi<span class="op">,</span>has<span class="op">)</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  lo <span class="op">=</span> lo <span class="kw">or</span> <span class="op">-</span><span class="fu">math.huge</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> new<span class="op">(</span><span class="cn">RANGE</span><span class="op">,</span> <span class="op">{</span>n<span class="op">=</span><span class="dv">0</span><span class="op">,</span>score<span class="op">=</span><span class="kw">nil</span><span class="op">,</span>col<span class="op">=</span>col<span class="op">,</span> lo<span class="op">=</span>lo<span class="op">,</span> hi<span class="op">=</span>hi <span class="kw">or</span> lo<span class="op">,</span> has<span class="op">=</span>has <span class="kw">or</span> SYM<span class="op">()})</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>__tostring<span class="op">(</span>i<span class="op">)</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i<span class="op">.</span>lo <span class="op">==</span> i<span class="op">.</span>hi       <span class="cf">then</span> <span class="cf">return</span> fmt<span class="op">(</span><span class="st">&quot;%s == %s&quot;</span><span class="op">,</span>i<span class="op">.</span>col<span class="op">.</span>txt<span class="op">,</span>i<span class="op">.</span>lo<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i<span class="op">.</span>lo <span class="op">==</span> <span class="op">-</span><span class="fu">math.huge</span> <span class="cf">then</span> <span class="cf">return</span> fmt<span class="op">(</span><span class="st">&quot;%s &lt; %s&quot;</span><span class="op">,</span>i<span class="op">.</span>col<span class="op">.</span>txt<span class="op">,</span>i<span class="op">.</span>hi<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i<span class="op">.</span>ho <span class="op">==</span>  <span class="fu">math.huge</span> <span class="cf">then</span> <span class="cf">return</span> fmt<span class="op">(</span><span class="st">&quot;%s &gt;= %s&quot;</span><span class="op">,</span>i<span class="op">.</span>col<span class="op">.</span>txt<span class="op">,</span>i<span class="op">.</span>lo<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> fmt<span class="op">(</span><span class="st">&quot;%s &lt;= %s &lt; %s&quot;</span><span class="op">,</span> i<span class="op">.</span>col<span class="op">.</span>txt<span class="op">,</span> i<span class="op">.</span>lo<span class="op">,</span> i<span class="op">.</span>hi<span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>x<span class="op">,</span>y<span class="op">)</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>n <span class="op">=</span> n<span class="op">.</span>n<span class="op">+</span><span class="dv">1</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>hi <span class="op">=</span> <span class="fu">math.max</span><span class="op">(</span>x<span class="op">,</span>i<span class="op">.</span>hi<span class="op">)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>lo <span class="op">=</span> <span class="fu">math.min</span><span class="op">(</span>x<span class="op">,</span>i<span class="op">.</span>lo<span class="op">)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  i<span class="op">.</span>has<span class="op">:</span>add<span class="op">(</span>y<span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>div<span class="op">(</span>i<span class="op">)</span> <span class="cf">return</span> i<span class="op">.</span>has<span class="op">:</span>div<span class="op">()</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>select<span class="op">(</span>i<span class="op">,</span>eg<span class="op">,</span>       x<span class="op">)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> eg<span class="op">.</span>has<span class="op">[</span>i<span class="op">.</span>col<span class="op">.</span>at<span class="op">]</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="kw">or</span> i<span class="op">.</span>lo <span class="op">&lt;=</span> x <span class="kw">and</span> x <span class="op">&lt;</span> i<span class="op">.</span>hi <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>merge<span class="op">(</span>i<span class="op">,</span>j<span class="op">,</span>      k<span class="op">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a> k <span class="op">=</span> RANGE<span class="op">(</span>i<span class="op">.</span>col<span class="op">,</span> i<span class="op">.</span>lo<span class="op">,</span> j<span class="op">.</span>hi<span class="op">,</span> i<span class="op">.</span>has<span class="op">:</span>merged<span class="op">(</span>j<span class="op">.</span>has<span class="op">))</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a> k<span class="op">.</span>n <span class="op">=</span> i<span class="op">.</span>n <span class="op">+</span> j<span class="op">.</span>n</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> k<span class="op">.</span>has<span class="op">:</span>div<span class="op">()*</span><span class="dv">1.01</span> <span class="op">&lt;=</span> xpects<span class="op">{</span>i<span class="op">,</span> j<span class="op">}</span> <span class="cf">then</span> <span class="cf">return</span> k <span class="cf">end</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">RANGE</span><span class="op">.</span>eval<span class="op">(</span>i<span class="op">,</span>goal<span class="op">)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> best<span class="op">,</span> rest<span class="op">,</span> goals <span class="op">=</span> <span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,{}</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> i<span class="op">.</span>score <span class="cf">then</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> goals<span class="op">.</span>smile<span class="op">(</span>b<span class="op">,</span>r<span class="op">)</span> <span class="cf">return</span> r<span class="op">&gt;</span>b <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> b<span class="op">*</span>b<span class="op">/(</span>b<span class="op">+</span>r <span class="op">+</span><span class="dv">1E-31</span><span class="op">)</span> <span class="kw">end</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> goals<span class="op">.</span>frown<span class="op">(</span>b<span class="op">,</span>r<span class="op">)</span> <span class="cf">return</span> b<span class="op">&lt;</span>r <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> r<span class="op">*</span>r<span class="op">/(</span>b<span class="op">+</span>r <span class="op">+</span><span class="dv">1E-31</span><span class="op">)</span> <span class="kw">end</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> goals<span class="op">.</span>xplor<span class="op">(</span>b<span class="op">,</span>r<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">/(</span>b<span class="op">+</span>r                <span class="op">+</span><span class="dv">1E-31</span><span class="op">)</span> <span class="kw">end</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> goals<span class="op">.</span>doubt<span class="op">(</span>b<span class="op">,</span>r<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">/(</span><span class="fu">math.abs</span><span class="op">(</span>b<span class="op">-</span>r<span class="op">)</span>      <span class="op">+</span><span class="dv">1E-31</span><span class="op">)</span> <span class="kw">end</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x<span class="op">,</span>n <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>i<span class="op">.</span>has<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> x<span class="op">==</span>goal <span class="cf">then</span> best <span class="op">=</span> best<span class="op">+</span>n<span class="op">/</span>i<span class="op">.</span>n <span class="cf">else</span> rest <span class="op">=</span> rest<span class="op">+</span>n<span class="op">/</span>i<span class="op">.</span>n <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    i<span class="op">.</span>score <span class="op">=</span> best <span class="op">+</span> rest <span class="op">&lt;</span> <span class="dv">0.01</span> <span class="kw">and</span> <span class="dv">0</span> <span class="kw">or</span> goals<span class="op">[</span>your<span class="op">.</span>goal<span class="op">](</span>best<span class="op">,</span>rest<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> i<span class="op">.</span>score <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb23"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">COLS</span><span class="op">.</span>new<span class="op">(</span>eg<span class="op">,</span>     i<span class="op">,</span>now<span class="op">,</span>where<span class="op">)</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  i <span class="op">=</span> new<span class="op">(</span><span class="cn">COLS</span><span class="op">,{</span>all<span class="op">={},</span> x<span class="op">={},</span> y<span class="op">={}})</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> at<span class="op">,</span>s <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>eg<span class="op">)</span> <span class="cf">do</span>    <span class="co">-- First row. Create the right columns</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    now   <span class="op">=</span> push<span class="op">(</span>i<span class="op">.</span>all<span class="op">,</span> <span class="op">(</span>s<span class="op">:</span><span class="fu">find</span><span class="st">&quot;^[A-Z]&quot;</span> <span class="kw">and</span> <span class="cn">NUM</span> <span class="kw">or</span> <span class="cn">SYM</span><span class="op">)(</span>at<span class="op">,</span>s<span class="op">))</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    where <span class="op">=</span> <span class="op">(</span>s<span class="op">:</span><span class="fu">find</span><span class="st">&quot;-&quot;</span> <span class="kw">or</span> s<span class="op">:</span><span class="fu">find</span><span class="st">&quot;+&quot;</span><span class="op">)</span> <span class="kw">and</span> i<span class="op">.</span>y <span class="kw">or</span> i<span class="op">.</span>x</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s<span class="op">:</span><span class="fu">find</span><span class="st">&quot;:&quot;</span> <span class="cf">then</span> push<span class="op">(</span>where<span class="op">,</span> now<span class="op">)</span> <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> i <span class="kw">end</span> </span></code></pre></div>
<div class="sourceCode" id="cb24"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">COLS</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>eg<span class="op">)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span><span class="op">(#</span>eg <span class="op">==</span> <span class="op">#</span>i<span class="op">.</span>all<span class="op">,</span><span class="st">&quot;expected a different number of cells&quot;</span><span class="op">)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> map<span class="op">(</span>i<span class="op">.</span>all<span class="op">,</span> <span class="kw">function</span><span class="op">(</span>col<span class="op">)</span> <span class="cf">return</span> col<span class="op">:</span>add<span class="op">(</span>eg<span class="op">[</span>col<span class="op">.</span>at<span class="op">])</span> <span class="kw">end</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb25"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>new<span class="op">(</span>i<span class="op">)</span> <span class="cf">return</span> new<span class="op">(</span><span class="cn">EGS</span><span class="op">,</span> <span class="op">{</span>rows<span class="op">={},</span> cols<span class="op">=</span><span class="kw">nil</span><span class="op">})</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>add<span class="op">(</span>i<span class="op">,</span>eg<span class="op">)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  eg <span class="op">=</span> eg<span class="op">.</span>has <span class="kw">and</span> eg<span class="op">.</span>has <span class="kw">or</span> eg <span class="co">-- If eg has data buried inside, expose it.</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i<span class="op">.</span>cols <span class="cf">then</span> push<span class="op">(</span>i<span class="op">.</span>rows<span class="op">,</span>EG<span class="op">(</span>i<span class="op">.</span>cols<span class="op">:</span>add<span class="op">(</span>eg<span class="op">)))</span> <span class="cf">else</span> i<span class="op">.</span>cols<span class="op">=</span>COLS<span class="op">(</span>eg<span class="op">)</span> <span class="cf">end</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>clone<span class="op">(</span>i<span class="op">,</span>inits<span class="op">,</span>    j<span class="op">)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  j <span class="op">=</span> EGS<span class="op">()</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  j<span class="op">:</span>add<span class="op">(</span>map<span class="op">(</span>i<span class="op">.</span>cols<span class="op">.</span>all<span class="op">,</span> <span class="kw">function</span><span class="op">(</span>col<span class="op">)</span> <span class="cf">return</span> col<span class="op">.</span>txt <span class="kw">end</span><span class="op">))</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>x <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>inits <span class="kw">or</span> <span class="op">{})</span> <span class="cf">do</span>  j<span class="op">:</span>add<span class="op">(</span>x<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> j <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>cluster<span class="op">(</span>i<span class="op">,</span> rows<span class="op">)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> zero<span class="op">,</span>one<span class="op">,</span>two<span class="op">,</span>ones<span class="op">,</span>twos<span class="op">,</span>both<span class="op">,</span>a<span class="op">,</span>b<span class="op">,</span>c </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  zero  <span class="op">=</span> any<span class="op">(</span>rows<span class="op">)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  one   <span class="op">=</span> i<span class="op">:</span>far<span class="op">(</span>zero<span class="op">)</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  two<span class="op">,</span>c <span class="op">=</span> i<span class="op">:</span>far<span class="op">(</span>one<span class="op">)</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  ones<span class="op">,</span>twos<span class="op">,</span>both <span class="op">=</span> i<span class="op">:</span>clone<span class="op">(),</span> i<span class="op">:</span>clone<span class="op">(),{}</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>eg <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>rows<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> eg<span class="op">:</span>dist<span class="op">(</span>one<span class="op">,</span> i<span class="op">)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> eg<span class="op">:</span>dist<span class="op">(</span>two<span class="op">,</span> i<span class="op">)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span>both<span class="op">,</span> <span class="op">{(</span>a<span class="op">^</span><span class="dv">2</span> <span class="op">+</span> c<span class="op">^</span><span class="dv">2</span> <span class="op">-</span> b<span class="op">^</span><span class="dv">2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="dv">2</span><span class="op">*</span>c<span class="op">),</span>eg<span class="op">})</span> <span class="cf">end</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> n<span class="op">,</span>pair <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="fu">sort</span><span class="op">(</span>both<span class="op">,</span> firsts<span class="op">))</span> <span class="cf">do</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>n <span class="op">&lt;=</span> <span class="op">#</span>both<span class="op">//</span><span class="dv">2</span> <span class="kw">and</span> ones <span class="kw">or</span> twos<span class="op">):</span>add<span class="op">(</span>pair<span class="op">[</span><span class="dv">2</span><span class="op">])</span> <span class="cf">end</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> your<span class="op">.</span>better <span class="kw">and</span> two<span class="op">:</span>better<span class="op">(</span>one<span class="op">,</span>i<span class="op">)</span> <span class="cf">then</span> ones<span class="op">,</span>twos<span class="op">=</span>twos<span class="op">,</span>ones <span class="cf">end</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ones<span class="op">,</span> twos <span class="kw">end</span>                             </span></code></pre></div>
<div class="sourceCode" id="cb29"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>far<span class="op">(</span>i<span class="op">,</span>eg1<span class="op">,</span>    fun<span class="op">,</span>tmp<span class="op">)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span>eg2<span class="op">)</span> <span class="cf">return</span> <span class="op">{</span>eg2<span class="op">,</span> eg1<span class="op">:</span>dist<span class="op">(</span>eg2<span class="op">,</span>i<span class="op">)}</span> <span class="kw">end</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  tmp <span class="op">=</span> <span class="op">#</span>i<span class="op">.</span>rows <span class="op">&gt;</span> your<span class="op">.</span><span class="cn">S</span>ome <span class="kw">and</span> any<span class="op">(</span>i<span class="op">.</span>rows<span class="op">,</span> your<span class="op">.</span><span class="cn">S</span>ome<span class="op">)</span> <span class="kw">or</span> i<span class="op">.</span>rows</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  tmp <span class="op">=</span> <span class="fu">sort</span><span class="op">(</span>map<span class="op">(</span>tmp<span class="op">,</span> fun<span class="op">),</span> seconds<span class="op">)</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">table.unpack</span><span class="op">(</span>tmp<span class="op">[#</span>tmp<span class="op">*</span>your<span class="op">.</span>far<span class="op">//</span><span class="dv">1</span><span class="op">]</span> <span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>from<span class="op">(</span>t<span class="op">,</span> i<span class="op">)</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  i<span class="op">=</span>i <span class="kw">or</span> EGS<span class="op">();</span> <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>eg <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> i<span class="op">:</span>add<span class="op">(</span>eg<span class="op">)</span> <span class="cf">end</span><span class="op">;</span> <span class="cf">return</span> i <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>mid<span class="op">(</span>i<span class="op">,</span>cols<span class="op">)</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> map<span class="op">(</span>cols <span class="kw">or</span> i<span class="op">.</span>all<span class="op">,</span> <span class="kw">function</span><span class="op">(</span>col<span class="op">)</span> <span class="cf">return</span> col<span class="op">:</span>mid<span class="op">()</span> <span class="kw">end</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>read<span class="op">(</span>file<span class="op">,</span> i<span class="op">)</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  i<span class="op">=</span>i <span class="kw">or</span> EGS<span class="op">();</span> <span class="cf">for</span> eg <span class="kw">in</span> csv<span class="op">(</span>file<span class="op">)</span> <span class="cf">do</span> i<span class="op">:</span>add<span class="op">(</span>eg<span class="op">)</span> <span class="cf">end</span><span class="op">;</span> <span class="cf">return</span> i <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">EGS</span><span class="op">.</span>superRanges<span class="op">(</span>i<span class="op">,</span>top<span class="op">)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> one<span class="op">,</span> two <span class="op">=</span> top<span class="op">:</span>cluster<span class="op">(</span>i<span class="op">.</span>rows<span class="op">)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> best<span class="op">,</span> out<span class="op">,</span> col2<span class="op">,</span> tmp<span class="op">,</span> ranges <span class="op">=</span> <span class="fu">math.huge</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> n<span class="op">,</span>col1 <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>one<span class="op">.</span>cols<span class="op">.</span>x<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    col2   <span class="op">=</span> two<span class="op">.</span>cols<span class="op">.</span>x<span class="op">[</span>n<span class="op">]</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    ranges <span class="op">=</span> col1<span class="op">:</span>superRanges<span class="op">(</span> col1<span class="op">:</span>ranges<span class="op">(</span>col2<span class="op">))</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">#</span>ranges <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>      tmp <span class="op">=</span> xpects<span class="op">(</span>ranges<span class="op">)</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> tmp <span class="op">&lt;</span> best <span class="cf">then</span> best<span class="op">,</span> out <span class="op">=</span> tmp<span class="op">,</span> ranges <span class="cf">end</span> <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">,</span> lefts<span class="op">,</span> firsts <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb34"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> any<span class="op">(</span>t<span class="op">,</span>  n<span class="op">)</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> n <span class="cf">then</span> <span class="cf">return</span> t<span class="op">[</span>randi<span class="op">(</span><span class="dv">1</span><span class="op">,#</span>t<span class="op">)]</span> <span class="cf">end</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  u<span class="op">={};</span><span class="cf">for</span> j<span class="op">=</span><span class="dv">1</span><span class="op">,</span>n <span class="cf">do</span> push<span class="op">(</span>u<span class="op">,</span> t<span class="op">[</span>randi<span class="op">(</span><span class="dv">1</span><span class="op">,#</span>t<span class="op">)])</span> <span class="cf">end</span><span class="op">;</span> <span class="cf">return</span> u <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>fails <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> asserts<span class="op">(</span>test<span class="op">,</span>msg<span class="op">)</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  msg<span class="op">=</span>msg <span class="kw">or</span> <span class="st">&quot;&quot;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> test <span class="cf">then</span> <span class="cf">return</span> <span class="fu">print</span><span class="op">(</span><span class="st">&quot;  PASS : &quot;</span><span class="op">..</span>msg<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  our<span class="op">.</span>fails <span class="op">=</span> our<span class="op">.</span>fails<span class="op">+</span><span class="dv">1</span>                       </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span><span class="op">(</span><span class="st">&quot;  FAIL : &quot;</span><span class="op">..</span>msg<span class="op">)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> your<span class="op">.</span><span class="cn">D</span>ebug <span class="cf">then</span> <span class="fu">assert</span><span class="op">(</span>test<span class="op">,</span>msg<span class="op">)</span> <span class="cf">end</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> coerce<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> x<span class="op">==</span><span class="st">&quot;true&quot;</span> <span class="cf">then</span> <span class="cf">return</span> <span class="kw">true</span> <span class="cf">elseif</span> x<span class="op">==</span><span class="st">&quot;false&quot;</span> <span class="cf">then</span> <span class="cf">return</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">tonumber</span><span class="op">(</span>x<span class="op">)</span> <span class="kw">or</span> x <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> copy<span class="op">(</span>t<span class="op">,</span>u<span class="op">)</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  u<span class="op">={};</span> <span class="cf">for</span> k<span class="op">,</span>v <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> u<span class="op">[</span>k<span class="op">]=</span>v <span class="cf">end</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">setmetatable</span><span class="op">(</span>u<span class="op">,</span> <span class="fu">getmetatable</span><span class="op">(</span>t<span class="op">))</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> csv<span class="op">(</span>file<span class="op">,</span>   x<span class="op">,</span>row<span class="op">)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> row<span class="op">(</span>x<span class="op">,</span>  t<span class="op">)</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> x<span class="op">:</span><span class="fu">gsub</span><span class="op">(</span><span class="st">&quot;%s+&quot;</span><span class="op">,</span><span class="st">&quot;&quot;</span><span class="op">):</span><span class="fu">gmatch</span><span class="st">&quot;([^,]+)&quot;</span> <span class="cf">do</span> push<span class="op">(</span>t<span class="op">,</span>coerce<span class="op">(</span>y<span class="op">))</span> <span class="cf">end</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> t </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span> <span class="co">-----------------</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  file <span class="op">=</span> <span class="fu">io.input</span><span class="op">(</span>file<span class="op">)</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span><span class="op">()</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="fu">io.read</span><span class="op">();</span> <span class="cf">if</span> x <span class="cf">then</span> <span class="cf">return</span> row<span class="op">(</span>x<span class="op">,{})</span> <span class="cf">else</span> <span class="fu">io.close</span><span class="op">(</span>file<span class="op">)</span> <span class="cf">end</span> <span class="kw">end</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> userSettings<span class="op">(</span>help_string<span class="op">,</span>       t<span class="op">,</span>fun<span class="op">)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> fun<span class="op">(</span>flag<span class="op">,</span>x<span class="op">)</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n<span class="op">,</span>txt <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span>arg<span class="op">)</span> <span class="cf">do</span>             </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>   txt<span class="op">:</span><span class="fu">sub</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">)==</span><span class="st">&quot;-&quot;</span> <span class="kw">and</span> flag<span class="op">:</span><span class="fu">match</span><span class="op">(</span><span class="st">&quot;^&quot;</span><span class="op">..</span>txt<span class="op">:</span><span class="fu">sub</span><span class="op">(</span><span class="dv">2</span><span class="op">)..</span><span class="st">&quot;.*&quot;</span><span class="op">)</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">then</span> x <span class="op">=</span> x<span class="op">==</span><span class="st">&quot;false&quot;</span> <span class="kw">and</span><span class="st">&quot;true&quot;</span> <span class="kw">or</span> x<span class="op">==</span><span class="st">&quot;true&quot;</span> <span class="kw">and</span><span class="st">&quot;false&quot;</span> <span class="kw">or</span> arg<span class="op">[</span>n<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="cf">end</span> <span class="cf">end</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    t<span class="op">[</span>flag<span class="op">]</span> <span class="op">=</span> coerce<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span> <span class="co">----------------- </span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  t <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  help_string<span class="op">:</span><span class="fu">gsub</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">  [-]([^%s]+)[^</span><span class="sc">\n</span><span class="st">]*%s([^%s]+)&quot;</span><span class="op">,</span> fun<span class="op">)</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> t <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> firsts<span class="op">(</span>a<span class="op">,</span>b<span class="op">)</span> <span class="cf">return</span> a<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&lt;</span> b<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> fmt<span class="op">(...)</span> <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(...)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> main<span class="op">(</span>user<span class="op">,</span> system<span class="op">,</span>      todos<span class="op">)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> function reset<span class="op">()</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k<span class="op">,</span>v <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>userSettings<span class="op">(</span>system<span class="op">.</span>help<span class="op">))</span> <span class="cf">do</span> user<span class="op">[</span>k<span class="op">]=</span>v <span class="cf">end</span> <span class="kw">end</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  reset<span class="op">()</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>   user<span class="op">.</span>h </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">then</span> <span class="fu">print</span><span class="op">(</span>system<span class="op">.</span>help<span class="op">)</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> system<span class="op">.</span>fails <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>       todos <span class="op">=</span> user<span class="op">.</span>todo<span class="op">==</span><span class="st">&quot;all&quot;</span> <span class="kw">and</span> slots<span class="op">(</span>system<span class="op">.</span>go<span class="op">)</span> <span class="kw">or</span> <span class="op">{</span>user<span class="op">.</span>todo<span class="op">}</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>one <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>todos<span class="op">)</span> <span class="cf">do</span> </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span>system<span class="op">.</span>go<span class="op">[</span>one<span class="op">])==</span><span class="st">&quot;function&quot;</span> <span class="cf">then</span> system<span class="op">.</span>go<span class="op">[</span>one<span class="op">]()</span> <span class="cf">end</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        reset<span class="op">()</span> <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> k<span class="op">,</span>v <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">_ENV</span><span class="op">)</span> <span class="cf">do</span> </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> system<span class="op">.</span>b4<span class="op">[</span>k<span class="op">]</span> <span class="cf">then</span> <span class="fu">print</span><span class="op">(</span><span class="st">&quot;?rogues&quot;</span><span class="op">,</span>k<span class="op">,</span><span class="fu">type</span><span class="op">(</span>v<span class="op">))</span> <span class="cf">end</span> <span class="cf">end</span> </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> system<span class="op">.</span>fails <span class="cf">end</span> </span></code></pre></div>
<div class="sourceCode" id="cb43"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> map<span class="op">(</span>t<span class="op">,</span>f<span class="op">,</span>  u<span class="op">)</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  u<span class="op">=</span> <span class="op">{};</span><span class="cf">for</span> k<span class="op">,</span>v <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> push<span class="op">(</span>u<span class="op">,(</span>f <span class="kw">or</span> same<span class="op">)(</span>v<span class="op">))</span> <span class="cf">end</span><span class="op">;</span> <span class="cf">return</span> u <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>oid<span class="op">=</span><span class="dv">0</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> new<span class="op">(</span>mt<span class="op">,</span>x<span class="op">)</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  our<span class="op">.</span>oid <span class="op">=</span> our<span class="op">.</span>oid<span class="op">+</span><span class="dv">1</span><span class="op">;</span> x<span class="op">.</span><span class="cn">_</span>oid <span class="op">=</span> our<span class="op">.</span>oid <span class="co">-- Everyone gets a unique id.</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">setmetatable</span><span class="op">(</span>x<span class="op">,</span>mt<span class="op">)</span> <span class="kw">end</span>        <span class="co">-- Methods now delegate to `mt`.</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> o<span class="op">(</span>t<span class="op">)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> u<span class="op">,</span>key</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  key<span class="op">=</span> <span class="kw">function</span><span class="op">(</span>k<span class="op">)</span> <span class="cf">return</span> fmt<span class="op">(</span><span class="st">&quot;:%s %s&quot;</span><span class="op">,</span> k<span class="op">,</span> o<span class="op">(</span>t<span class="op">[</span>k<span class="op">]))</span> <span class="kw">end</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span>t<span class="op">)</span> <span class="op">~=</span> <span class="st">&quot;table&quot;</span> <span class="cf">then</span> <span class="cf">return</span> <span class="fu">tostring</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  u <span class="op">=</span> <span class="op">#</span>t<span class="op">&gt;</span><span class="dv">0</span> <span class="kw">and</span> map<span class="op">(</span>t<span class="op">,</span>o<span class="op">)</span> <span class="kw">or</span> map<span class="op">(</span>slots<span class="op">(</span>t<span class="op">),</span>key<span class="op">)</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>t<span class="op">.</span><span class="cn">_</span>is <span class="kw">or</span> <span class="st">&quot;&quot;</span><span class="op">)..</span><span class="st">&quot;{&quot;</span><span class="op">..</span>table<span class="op">.</span>concat<span class="op">(</span>u<span class="op">,</span> <span class="st">&quot; &quot;</span><span class="op">)..</span><span class="st">&quot;}&quot;</span> <span class="kw">end</span> </span></code></pre></div>
<div class="sourceCode" id="cb46"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> push<span class="op">(</span>t<span class="op">,</span>x<span class="op">)</span> <span class="fu">table.insert</span><span class="op">(</span>t<span class="op">,</span>x<span class="op">);</span> <span class="cf">return</span> x <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>your<span class="op">.</span>seed <span class="op">=</span> your<span class="op">.</span>seed <span class="kw">or</span> <span class="dv">10019</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> rand<span class="op">(</span>lo<span class="op">,</span>hi<span class="op">)</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  your<span class="op">.</span>seed <span class="op">=</span> <span class="op">(</span><span class="dv">16807</span> <span class="op">*</span> your<span class="op">.</span>seed<span class="op">)</span> <span class="op">%</span> <span class="dv">2147483647</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>lo <span class="kw">or</span> <span class="dv">0</span><span class="op">)</span> <span class="op">+</span> <span class="op">((</span>hi <span class="kw">or</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span>lo <span class="kw">or</span> <span class="dv">0</span><span class="op">))</span> <span class="op">*</span> your<span class="op">.</span>seed <span class="op">/</span> <span class="dv">2147483647</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> randi<span class="op">(</span>lo<span class="op">,</span>hi<span class="op">)</span> <span class="cf">return</span> <span class="fu">math.floor</span><span class="op">(</span><span class="dv">0.5</span> <span class="op">+</span> rand<span class="op">(</span>lo<span class="op">,</span>hi<span class="op">))</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> rnd<span class="op">(</span>x<span class="op">,</span>d<span class="op">,</span>  n<span class="op">)</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span>x<span class="op">)~=</span><span class="st">&quot;number&quot;</span> <span class="cf">then</span> <span class="cf">return</span> x <span class="cf">end</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  n<span class="op">=</span><span class="dv">10</span><span class="op">^(</span>d <span class="kw">or</span> your<span class="op">.</span>round<span class="op">)</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">math.floor</span><span class="op">(</span>x<span class="op">*</span>n<span class="op">+</span><span class="dv">0.5</span><span class="op">)/</span>n <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> rnds<span class="op">(</span>t<span class="op">,</span>d<span class="op">)</span> <span class="cf">return</span> map<span class="op">(</span>t<span class="op">,</span><span class="kw">function</span><span class="op">(</span>x<span class="op">)</span> <span class="cf">return</span> rnd<span class="op">(</span>x<span class="op">,</span>d<span class="op">)</span> <span class="kw">end</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb51"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> same<span class="op">(</span>x<span class="op">,...)</span> <span class="cf">return</span> x <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> seconds<span class="op">(</span>a<span class="op">,</span>b<span class="op">)</span> <span class="cf">return</span> a<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">&lt;</span> b<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> slots<span class="op">(</span>t<span class="op">,</span>   u<span class="op">)</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  u<span class="op">={}</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> k<span class="op">,</span><span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> <span class="cf">if</span> <span class="fu">tostring</span><span class="op">(</span>k<span class="op">):</span><span class="fu">sub</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span> <span class="op">~=</span> <span class="st">&quot;_&quot;</span> <span class="cf">then</span> push<span class="op">(</span>u<span class="op">,</span>k<span class="op">)</span> <span class="cf">end</span> <span class="cf">end</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">sort</span><span class="op">(</span>u<span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sort</span><span class="op">(</span>t<span class="op">,</span>f<span class="op">)</span> <span class="fu">table.sort</span><span class="op">(</span>t<span class="op">,</span>f<span class="op">);</span>   <span class="cf">return</span> t <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb55"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> xpects<span class="op">(</span>t<span class="op">)</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> sum<span class="op">,</span>n <span class="op">=</span> <span class="dv">0</span><span class="op">,</span><span class="dv">0</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span>z <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span>t<span class="op">)</span> <span class="cf">do</span> n <span class="op">=</span> n <span class="op">+</span> z<span class="op">.</span>n<span class="op">;</span> sum <span class="op">=</span> sum <span class="op">+</span> z<span class="op">.</span>n<span class="op">*</span>z<span class="op">:</span>div<span class="op">()</span> <span class="cf">end</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sum<span class="op">/</span>n <span class="kw">end</span></span></code></pre></div>
<hr />
<div class="sourceCode" id="cb56"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>go<span class="op">={}</span>   <span class="co">-- list of enabled tests</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>our<span class="op">.</span>nogo<span class="op">={}</span> <span class="co">-- list of disabled test</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> go<span class="op">,</span> nogo <span class="op">=</span> our<span class="op">.</span>go<span class="op">,</span>our<span class="op">.</span>nogo</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>settings<span class="op">()</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span><span class="op">(</span><span class="st">&quot;our&quot;</span><span class="op">,</span>o<span class="op">(</span>our<span class="op">))</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span><span class="op">(</span><span class="st">&quot;your&quot;</span><span class="op">,</span>o<span class="op">(</span>your<span class="op">))</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>range<span class="op">(</span>  r<span class="op">)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  r<span class="op">=</span>RANGE<span class="op">(</span>NUM<span class="op">(</span><span class="dv">10</span><span class="op">,</span><span class="st">&quot;fred&quot;</span><span class="op">),</span><span class="st">&quot;apple&quot;</span><span class="op">)</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span><span class="op">(</span><span class="fu">tostring</span><span class="op">(</span>r<span class="op">)</span> <span class="op">==</span> <span class="st">&quot;fred == apple&quot;</span><span class="op">,</span> <span class="st">&quot;print ok&quot;</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb59"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>num<span class="op">(</span>    m<span class="op">,</span>n<span class="op">)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  m<span class="op">=</span>NUM<span class="op">();</span>   <span class="cf">for</span> j<span class="op">=</span><span class="dv">1</span><span class="op">,</span><span class="dv">10</span> <span class="cf">do</span> m<span class="op">:</span>add<span class="op">(</span>j<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  n<span class="op">=</span>copy<span class="op">(</span>m<span class="op">);</span> <span class="cf">for</span> j<span class="op">=</span><span class="dv">1</span><span class="op">,</span><span class="dv">10</span> <span class="cf">do</span> n<span class="op">:</span>add<span class="op">(</span>j<span class="op">)</span> <span class="cf">end</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  asserts<span class="op">(</span><span class="dv">2.95</span> <span class="op">==</span> rnd<span class="op">(</span>n<span class="op">:</span>div<span class="op">()),</span><span class="st">&quot;sd ok&quot;</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb60"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>egs<span class="op">(</span>    egs<span class="op">)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  egs <span class="op">=</span> <span class="cn">EGS</span><span class="op">.</span>read<span class="op">(</span>your<span class="op">.</span>file<span class="op">)</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  asserts<span class="op">(</span>egs<span class="op">.</span>cols<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">].</span>hi<span class="op">==</span><span class="dv">5140</span><span class="op">,</span><span class="st">&quot;most seen&quot;</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb61"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>clone<span class="op">(</span>     egs1<span class="op">,</span>egs2<span class="op">,</span>s1<span class="op">,</span>s2<span class="op">)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  egs1 <span class="op">=</span> <span class="cn">EGS</span><span class="op">.</span>read<span class="op">(</span>your<span class="op">.</span>file<span class="op">)</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  s1   <span class="op">=</span> o<span class="op">(</span>egs1<span class="op">.</span>cols<span class="op">.</span>y<span class="op">)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  egs2 <span class="op">=</span> egs1<span class="op">:</span>clone<span class="op">(</span>egs1<span class="op">.</span>rows<span class="op">)</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  s2   <span class="op">=</span> o<span class="op">(</span>egs2<span class="op">.</span>cols<span class="op">.</span>y<span class="op">)</span> </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  asserts<span class="op">(</span>s1<span class="op">==</span>s2<span class="op">,</span> <span class="st">&quot;cloning works&quot;</span><span class="op">)</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb62"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>dist<span class="op">()</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> egs<span class="op">,</span>eg1<span class="op">,</span>dist<span class="op">,</span>tmp<span class="op">,</span>j1<span class="op">,</span>j2<span class="op">,</span>d1<span class="op">,</span>d2<span class="op">,</span>d3<span class="op">,</span>one</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  egs  <span class="op">=</span> <span class="cn">EGS</span><span class="op">.</span>read<span class="op">(</span>your<span class="op">.</span>file<span class="op">)</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  eg1  <span class="op">=</span> egs<span class="op">.</span>rows<span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  dist <span class="op">=</span> <span class="kw">function</span><span class="op">(</span>eg2<span class="op">)</span> <span class="cf">return</span> <span class="op">{</span>eg2<span class="op">,</span>eg1<span class="op">:</span>dist<span class="op">(</span>eg2<span class="op">,</span>egs<span class="op">)}</span> <span class="kw">end</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  tmp  <span class="op">=</span> <span class="fu">sort</span><span class="op">(</span>map<span class="op">(</span>egs<span class="op">.</span>rows<span class="op">,</span> dist<span class="op">),</span> seconds<span class="op">)</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  one  <span class="op">=</span> tmp<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> j<span class="op">=</span><span class="dv">1</span><span class="op">,</span><span class="dv">10</span> <span class="cf">do</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    j1 <span class="op">=</span> randi<span class="op">(</span><span class="dv">1</span><span class="op">,#</span>tmp<span class="op">)</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    j2 <span class="op">=</span> randi<span class="op">(</span><span class="dv">1</span><span class="op">,#</span>tmp<span class="op">)</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> j1<span class="op">&gt;</span>j2 <span class="cf">then</span> j1<span class="op">,</span>j2<span class="op">=</span>j2<span class="op">,</span>j1 <span class="cf">end</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> tmp<span class="op">[</span>j1<span class="op">][</span><span class="dv">1</span><span class="op">]:</span>dist<span class="op">(</span>one<span class="op">,</span>egs<span class="op">)</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> tmp<span class="op">[</span>j2<span class="op">][</span><span class="dv">1</span><span class="op">]:</span>dist<span class="op">(</span>one<span class="op">,</span>egs<span class="op">)</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    asserts<span class="op">(</span>d1 <span class="op">&lt;=</span> d2<span class="op">,</span><span class="st">&quot;distance &quot;</span><span class="op">)</span> <span class="cf">end</span> <span class="kw">end</span></span></code></pre></div>
<div class="sourceCode" id="cb63"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> go<span class="op">.</span>cluster<span class="op">(</span>   top<span class="op">,</span>left<span class="op">,</span>right<span class="op">)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  top <span class="op">=</span> <span class="cn">EGS</span><span class="op">.</span>read<span class="op">(</span>your<span class="op">.</span>file<span class="op">)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  left<span class="op">,</span> right <span class="op">=</span> top<span class="op">:</span>cluster<span class="op">()</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> n<span class="op">,</span>t <span class="kw">in</span> <span class="fu">pairs</span><span class="op">{</span>top<span class="op">,</span>left<span class="op">,</span>right<span class="op">}</span> <span class="cf">do</span> <span class="fu">print</span><span class="op">(</span>n<span class="op">,</span>o<span class="op">(</span>rnds<span class="op">(</span>t<span class="op">:</span>mid<span class="op">(</span>t<span class="op">.</span>cols<span class="op">.</span>y<span class="op">))))</span> <span class="cf">end</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>assuming our.go = demos and our.help==help string and our.fails = 0
then</p>
<p>```lua os.exit( main(your, our))</p>
</body>
</html>
