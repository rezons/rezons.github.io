<!DOCTYPE html>

<html>
<head>
  <title>keys4.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>keys4.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h2 id="about">About</h2>
<p>Keys4 is a <a href="https://arxiv.org/abs/1812.01550">“DUO” algorithm</a>
(data mining using/used by optimizers) that seeks to learn the
most it can about some  model <code>y=f(x)</code>, while at the same time, asking the fewest
questions about <code>x</code> or <code>y</code>.  </p>
<p>Keys4 assumes the presence of <a href="http://menzies.us/pdf/07strange.pdf">“keys”</a>
in the data;
i.e. a small set of variables which, if set, greatly reduces the variance of
the rest of the system. For such systems, inference and explanation and control
is a simple matter of (a) random sampling; (b) then focusing on a few variables that
are most different in the sample,</p>
<p>In Keys4, examples are divided in two (on their <code>x</code> value) then
discretion seeks the attribute range that best distinguishes that division. Data is split
on that range and the process repeats recursively to return a binary decision tree that
queries one attribute range per split.  If called with the <code>-best</code> flag, Keys4 evaluates
two distant examples per split, pruning the split with the worst example (so N examples
can be pruned after a small (log(N)) number of examples.</p>
<p>Keys4 divides its data using recursive <a href="https://dl.acm.org/doi/10.1145/568271.223812">FASTMAP random
projections</a>.  Different to most classifiers
or regression algorithms, Keys4 allows ranks examples on a multi-objective criteria using
<a href="https://www.simonkuenzli.ch/docs/ZK04.pdf">Zitler’s IBEA</a> predicate (which is known to be
effective for 
<a href="https://fada.birzeit.edu/bitstream/20.500.11889/4528/1/dcb6eddbdac1c26b605ce3dff62e27167848.pdf">multi- to many- goals</a>.
Also, except for the handful of <code>y</code> queries used by the optional  <code>-best</code> flag, this is an
<a href="https://raw.githubusercontent.com/nzjohng/publications/master/papers/jss2020.pdf">unsupervised algorithm</a>.
Keys4 can be used  when example labels are suspect since, even if called with <code>-best</code>,
humans only have to check a very small number of labels (in this way, Keys4 is like a
semi-supervised learner that takes most advantage of a very small number of labels).</p>
<p>Other applications of Keys4 include <a href="https://arxiv.org/pdf/2006.00093.pdf">explaining</a>
complex models (in a succinct manner). Unlike other explanation that discuss the impact of
single variables on a class, Keys4 offers explanations for combinations of multiple
factors that influence multiple goals.  Keys4 can also optimize any simulation process
here is to expensive to evaluate too many examples. Further,for <a href="https://arxiv.org/pdf/2110.02922.pdf">interactive search-based
software engineering</a>, Keys4 lets a human work with
an AI, without the human being overwhelmed by too many questions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> MINE={b4={}, help=<span class="hljs-string">[[

keys4 [OPTIONS]
Optimizes N items using just O(log(N)) evaluations.
(c)2022, Tim Menzies &lt;timm@ieee.org&gt;, unlicense.org

OPTIONS:
  -best      Recurse on just best half      : false
  -Debug     on error, dump stack and exit  : false
  -dull   F  small effect= stdev*dull       : .35
  -Far    F  where to find far things       : .9
  -file   S  read data from file : ../../data/auto93.csv
  -goal   S  smile,frown,xplor,doubt        : smile
  -h         show help                      : false
  -p      I  distance coefficient           : 2
  -Rest   F  size of rest set is Rest*best  : 4
  -round  I  round floats to round places : 2
  -seed   I  random number seed             : 10019
  -Small  F  splits at #t^small             : .5
  -todo   S  start-up action                : pass
             -todo ALL = run all
             -todo LS  = list all
  -verbose   show details                   : false
]]</span>}  
<span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> MINE.b4[k]=k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="namespace">Namespace</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h3 id="classes">Classes</h3>
<p>Our class print themselves with the <code>o</code> function, 
and delegate methods to <code>klass</code> and 
set the creation method <code>XX(..)</code> to be <code>XX.new(...)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">klass</span><span class="hljs-params">(s, klass)</span></span>
  klass = {_is=s, <span class="hljs-built_in">__tostring</span>=o}; 
  klass.<span class="hljs-built_in">__index</span> = klass
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(klass,{<span class="hljs-built_in">__call</span>=<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,...)</span></span> <span class="hljs-keyword">return</span> klass.new(...) <span class="hljs-keyword">end</span>}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>A <code>SAMPLE</code> holds many <code>EG</code>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> EG, SAMPLE = klass<span class="hljs-string">&quot;EG&quot;</span>, klass<span class="hljs-string">&quot;SAMPLE&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Example columns are either  <code>NUM</code>eric or  <code>SYM</code>bolic  or black holes (for data we want to <code>SKIP</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> NUM, SYM, SKIP  = klass<span class="hljs-string">&quot;NUM&quot;</span>, klass<span class="hljs-string">&quot;SYM&quot;</span>, klass<span class="hljs-string">&quot;SKIP&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h3 id="globals">Globals</h3>
<p>Internal options (not controlled by command-line).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MINE.go    = {} <span class="hljs-comment">-- where to store demos/tests</span>
MINE.nogo  = {} <span class="hljs-comment">-- where to store disabled demos/tests</span>
MINE.oid   = <span class="hljs-number">0</span>  <span class="hljs-comment">-- object id counter</span>
MINE.fails = <span class="hljs-number">0</span>  <span class="hljs-comment">-- counter for runtime errors</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Config options, set from <code>MY</code> help string via<br><code>YOUR = options(MINE.help)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> YOUR = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h3 id="misc-functions">Misc functions</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> coerce, options                     <span class="hljs-comment">-- make config options</span>
<span class="hljs-keyword">local</span> push,firsts,<span class="hljs-built_in">sort</span>,map,slots,copy     <span class="hljs-comment">-- table stuff</span>
<span class="hljs-keyword">local</span> csv,green,yellow,rnd,rnds,fmt,say,o <span class="hljs-comment">-- Print Stuff</span>
<span class="hljs-keyword">local</span> rand,randi,any,many,shuffle         <span class="hljs-comment">-- Random stuff</span>
<span class="hljs-keyword">local</span> xpect                               <span class="hljs-comment">-- Misc stuff</span>
<span class="hljs-keyword">local</span> ako, new                            <span class="hljs-comment">-- OO stuff</span>
<span class="hljs-keyword">local</span> main, azzert                        <span class="hljs-comment">-- Start-up and main stuff</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h2 id="sample">Sample</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.new</span><span class="hljs-params">(inits,   i)</span></span> 
  i= new(SAMPLE, {head=<span class="hljs-literal">nil</span>,egs={},all={},num={},sym={},xs={},ys={}}) 
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(inits)==<span class="hljs-string">&quot;table&quot;</span>  <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> _,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits) <span class="hljs-keyword">do</span> i:add(eg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(inits)==<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> eg <span class="hljs-keyword">in</span> csv(inits)   <span class="hljs-keyword">do</span> i:add(eg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.split</span><span class="hljs-params">(i, egs)</span></span>
  <span class="hljs-keyword">local</span> c,best,rest,here,there
  egs     = egs <span class="hljs-keyword">or</span> i.egs
  here    = i:far(any(egs), egs)
  there,c = i:far(here,     egs)
  <span class="hljs-keyword">for</span> _,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(egs) <span class="hljs-keyword">do</span>
    eg.x = (eg:dist(here,i)^<span class="hljs-number">2</span> + c^<span class="hljs-number">2</span> - eg:dist(there,i)^<span class="hljs-number">2</span>) / (<span class="hljs-number">2</span>*c) <span class="hljs-keyword">end</span>
  best,rest = i:clone(), i:clone()
  <span class="hljs-keyword">for</span> n,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(egs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a.x &lt; b.x <span class="hljs-keyword">end</span>)) <span class="hljs-keyword">do</span>
    (n &lt;= #egs//<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> best <span class="hljs-keyword">or</span> rest):add(eg) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> best, rest <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.tussling</span><span class="hljs-params">(i,min,lvl,pre)</span></span>
  lvl = lvl <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
  <span class="hljs-built_in">min</span> = <span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> <span class="hljs-number">2</span>*(#i.egs)^YOUR.Small
  <span class="hljs-keyword">if</span> #i.egs &lt; <span class="hljs-number">2</span>*<span class="hljs-built_in">min</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> best,rest = i:split(i.egs)
  <span class="hljs-keyword">local</span> bins = {}
  <span class="hljs-keyword">for</span> n,bestx <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(best.xs) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">for</span> _,bin <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bestx:bins(rest.xs[n])) <span class="hljs-keyword">do</span> push(bins, bin) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> score = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a.has:score(<span class="hljs-string">&quot;best&quot;</span>) &gt; b.has:score(<span class="hljs-string">&quot;best&quot;</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> bin   = <span class="hljs-built_in">sort</span>(bins, score)[<span class="hljs-number">1</span>]
  <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;%s %-20s%4s : %s&quot;</span>, 
                        o(rnds(i:stats(i.ys),<span class="hljs-number">0</span> )),
                        <span class="hljs-built_in">string</span>.<span class="hljs-built_in">rep</span>(<span class="hljs-string">&quot;|.. &quot;</span>,lvl), 
                        #i.egs, pre <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>))
  pre = bin.lo == bin.hi <span class="hljs-keyword">and</span> fmt(<span class="hljs-string">&quot;%s&quot;</span>,bin.lo) <span class="hljs-keyword">or</span> fmt(<span class="hljs-string">&quot;(%s..%s)&quot;</span>,bin.lo,bin.hi)
  pre = fmt(<span class="hljs-string">&quot;%s = %s&quot;</span>, bin.col.txt, pre)
  <span class="hljs-keyword">local</span> left, right = i:clone(), i:clone()
  <span class="hljs-keyword">for</span> _,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.egs) <span class="hljs-keyword">do</span>
     <span class="hljs-keyword">local</span> x = eg.has[ bin.col.at ]
     <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span>                 <span class="hljs-keyword">then</span> left:add(eg); right:add(eg) 
     <span class="hljs-keyword">elseif</span> bin.lo&lt;=x <span class="hljs-keyword">and</span> x&lt;bin.hi <span class="hljs-keyword">then</span> left:add(eg) 
     <span class="hljs-keyword">else</span>                               right:add(eg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">if</span> #left.egs  &lt; #i.egs <span class="hljs-keyword">then</span> left:tussling( <span class="hljs-built_in">min</span>, lvl+<span class="hljs-number">1</span>,<span class="hljs-string">&quot;if &quot;</span>.. pre) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> #right.egs &lt; #i.egs <span class="hljs-keyword">then</span> right:tussling(<span class="hljs-built_in">min</span>, lvl+<span class="hljs-number">1</span>,<span class="hljs-string">&quot;if not &quot;</span>..pre) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.skip</span><span class="hljs-params">(i,  x)</span></span> <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.nump</span><span class="hljs-params">(i,  x)</span></span> <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.goalp</span><span class="hljs-params">(i, x)</span></span> <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">or</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;+&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.add</span><span class="hljs-params">(i,eg,    now)</span></span>
  eg = eg.has <span class="hljs-keyword">and</span> eg.has <span class="hljs-keyword">or</span> eg
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.head <span class="hljs-keyword">then</span>
    i.head = eg
    <span class="hljs-keyword">for</span> n,s <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(eg) <span class="hljs-keyword">do</span> 
      now = (i:skip(s) <span class="hljs-keyword">and</span> SKIP <span class="hljs-keyword">or</span> i:nump(s) <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(n,s)
      push(i.all, now)
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i:skip(s) <span class="hljs-keyword">then</span> 
        push(i:goalp(s) <span class="hljs-keyword">and</span> i.ys <span class="hljs-keyword">or</span> i.xs, now) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">else</span> 
    push(i.egs, EG(eg))
    <span class="hljs-keyword">for</span> n,one <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> one:add(eg[one.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.clone</span><span class="hljs-params">(i,inits,    j)</span></span>
  j= SAMPLE()
  j:add(copy(i.head))
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span>  j:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.stats</span><span class="hljs-params">(i, cols)</span></span> 
  <span class="hljs-keyword">return</span> map(cols <span class="hljs-keyword">or</span> i.all, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x:mid() <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
  
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SAMPLE.far</span><span class="hljs-params">(i,eg1,egs,    gap,tmp)</span></span>
  gap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eg2)</span></span> <span class="hljs-keyword">return</span> {eg2, eg1:dist(eg2,i)} <span class="hljs-keyword">end</span>
  tmp = <span class="hljs-built_in">sort</span>(map(egs, gap), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[<span class="hljs-number">2</span>] &lt; b[<span class="hljs-number">2</span>] <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>(tmp[#tmp*YOUR.Far//<span class="hljs-number">1</span>] ) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <h2 id="eg">EG</h2>
<p>SAMPLEs store individual EGs (examples).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EG.new</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> new(EG, {klass=<span class="hljs-number">0</span>,has=t}) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EG.cols</span><span class="hljs-params">(i,cols)</span></span> <span class="hljs-keyword">return</span> map(cols, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> i.has[x.at] <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EG.dist</span><span class="hljs-params">(i,j,smpl,   a,b,d,n,inc,dist1)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist1</span><span class="hljs-params">(num,a,b)</span></span>
    <span class="hljs-keyword">if</span>   num 
    <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span>     a==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> b=num:norm(b); a=b&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
         <span class="hljs-keyword">elseif</span> b==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> a=num:norm(a); b=a&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
         <span class="hljs-keyword">else</span>   a,b = num:norm(a), num:norm(b) <span class="hljs-keyword">end</span>
         <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(a-b) 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> a==b <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

  d,n = <span class="hljs-number">0</span>,<span class="hljs-number">1E-31</span>
  <span class="hljs-keyword">for</span> col,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(smpl.xs) <span class="hljs-keyword">do</span>
    n   = n+<span class="hljs-number">1</span>
    a,b = i.has[col], j.has[col]
    inc = a==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> b==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> dist1(smpl.num[col],a,b)
    d   = d + inc^YOUR.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/n)^(<span class="hljs-number">1</span>/YOUR.p) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EG.better</span><span class="hljs-params">(eg1,eg2,smpl,    e,n,a,b,s1,s2)</span></span>
  s1,s2,e,n = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,#smpl.ys
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(smpl.ys) <span class="hljs-keyword">do</span>
    a   = col:norm(eg1.has[col.at])
    b   = col:norm(eg2.has[col.at])
    s1  = s1 - e^(col.w * (a-b)/n) 
    s2  = s2 - e^(col.w * (b-a)/n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/n &lt; s2/n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h2 id="columns">Columns</h2>
<h3 id="columns-to-skip">Columns to <code>SKIP</code></h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SKIP.new</span><span class="hljs-params">(n,s)</span></span>  <span class="hljs-keyword">return</span> new(SKIP, {txt=s <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>, at=n <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SKIP.add</span><span class="hljs-params">(i,x)</span></span>  <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SKIP.mid</span><span class="hljs-params">()</span></span>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SKIP.bins</span><span class="hljs-params">(...)</span></span> <span class="hljs-keyword">return</span> {} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <h3 id="numeric-columns"><code>NUM</code>eric columns</h3>
<p><strong>NUM(n?:posint, s?:string) : NUM</strong><br>Creates a new number in column <code>n</code> with name <code>s</code>.<br>Stores on the seen values in <code>_has</code>.<br>If the name <code>s</code> contains “-“, then that is a goal to be minimized
with weight <code>w=-1</code> (else the weight defaults to <code>w=1</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.new</span><span class="hljs-params">(n,s)</span></span>  
  <span class="hljs-keyword">return</span> new(NUM, {txt=s <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>, at=n <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,lo=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>, hi=-<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>,
                   _has={},
                   n=<span class="hljs-number">0</span>,mu=<span class="hljs-number">0</span>,m2=<span class="hljs-number">0</span>,w=(s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>}) <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> _bins
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.bins</span><span class="hljs-params">(i,j,         x,xys,xstats)</span></span>
  xys = {}
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i._has) <span class="hljs-keyword">do</span> push(xys, {x=x, y=<span class="hljs-string">&quot;best&quot;</span>}) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j._has) <span class="hljs-keyword">do</span> push(xys, {x=x, y=<span class="hljs-string">&quot;rest&quot;</span>}) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> _bins(xys, xpect(i,j)*YOUR.dull, (#xys)^YOUR.Small, i, SYM) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_bins</span><span class="hljs-params">(xys,dull,small,col,yklass,      bin,bins,merge,span,spans)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(b4,    j,tmp,maybe,now,after)</span></span> 
    j, tmp = <span class="hljs-number">0</span>, {}
    <span class="hljs-keyword">while</span> j &lt; #b4 <span class="hljs-keyword">do</span>
      j = j + <span class="hljs-number">1</span>
      now, after = b4[j], b4[j+<span class="hljs-number">1</span>]
      <span class="hljs-keyword">if</span> after <span class="hljs-keyword">then</span> 
        maybe = now.has:merge(after.has)
        <span class="hljs-keyword">if</span> maybe:div()*<span class="hljs-number">1.01</span> &lt;= xpect(now.has, after.has) <span class="hljs-keyword">then</span> 
           now = {col=col, lo=now.lo, hi= after.hi, has=maybe} 
           j = j + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
      push(tmp,now) <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> #tmp==#b4 <span class="hljs-keyword">and</span> b4 <span class="hljs-keyword">or</span> merge(tmp) <span class="hljs-keyword">end</span>

  bin  = {col=col, lo=xys[<span class="hljs-number">1</span>].x, hi=xys[<span class="hljs-number">1</span>].x, has=yklass()}
  bins = {bin}
  <span class="hljs-keyword">for</span> j,xy <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(xys, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a.x &lt; b.x <span class="hljs-keyword">end</span>)) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span>   j &lt; #xys - small   <span class="hljs-keyword">and</span>   <span class="hljs-comment">-- enough items remaining after split</span>
         xy.x ~= xys[j+<span class="hljs-number">1</span>].x  <span class="hljs-keyword">and</span>  <span class="hljs-comment">-- next item is different (so can split here)</span>
         bin.has.n &gt; small <span class="hljs-keyword">and</span>   <span class="hljs-comment">-- bin has enough items</span>
         bin.hi - bin.lo &gt; dull <span class="hljs-comment">-- bin is not trivially small  </span>
    <span class="hljs-keyword">then</span> bin = push(bins, {col=col, lo=bin.hi, hi=xy.x, has=yklass()}) <span class="hljs-keyword">end</span>  
    bin.hi = xy.x 
    bin.has:add(xy.y) <span class="hljs-keyword">end</span> 
  bins[<span class="hljs-number">1</span>].lo     = -<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
  bins[#bins].hi =  <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
  <span class="hljs-keyword">return</span> merge(bins) <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.mid</span><span class="hljs-params">(i)</span></span>   <span class="hljs-keyword">return</span> i.mu <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.div</span><span class="hljs-params">(i)</span></span> <span class="hljs-keyword">return</span> i.n&lt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (i.m2/(i.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.add</span><span class="hljs-params">(i,x,    d)</span></span>  
  <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    push(i._has,x)
    i.n = i.n+<span class="hljs-number">1</span>; d=x-i.mu; i.mu=i.mu+d/i.n; i.m2=i.m2+d*(x-i.mu) 
    i.hi= <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(i.hi,x)
    i.lo= <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(i.lo,x) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.norm</span><span class="hljs-params">(i,x)</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(i.lo - i.hi) &lt; <span class="hljs-number">1E-32</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x - i.lo) / (i.hi - i.lo) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.merge</span><span class="hljs-params">(i,j,    k)</span></span>
  k=NUM(i.at, i.txt)
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j._has) <span class="hljs-keyword">do</span> k:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h3 id="symbolic-columns"><code>SYM</code>bolic Columns</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.new</span><span class="hljs-params">(n,s)</span></span> 
  <span class="hljs-keyword">return</span> new(SYM, {n=<span class="hljs-number">0</span>,has={},txt=s <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>, at=n <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,mode=<span class="hljs-literal">nil</span>,most=<span class="hljs-number">0</span>}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.add</span><span class="hljs-params">(i,x,n)</span></span> 
  <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    n        = n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    i.n      = i.n+  n 
    i.has[x] = n+(i.has[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) 
    <span class="hljs-keyword">if</span> i.has[x] &gt; i.most <span class="hljs-keyword">then</span> i.most, i.mode = i.has[x], x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.mid</span><span class="hljs-params">(i)</span></span>     <span class="hljs-keyword">return</span> i.mode <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.div</span><span class="hljs-params">(i,   e)</span></span>  
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span> e = e - n/i.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/i.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.merge</span><span class="hljs-params">(i,j,    k)</span></span> 
  k = SYM(i.at,i.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.bins</span><span class="hljs-params">(i,j,        bins,t)</span></span>
  t,bins = {},{}
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span>  t[x] = t[x] <span class="hljs-keyword">or</span> SYM(); t[x]:add(<span class="hljs-string">&quot;best&quot;</span>,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.has) <span class="hljs-keyword">do</span>  t[x] = t[x] <span class="hljs-keyword">or</span> SYM(); t[x]:add(<span class="hljs-string">&quot;rest&quot;</span>,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,stats <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
    push(bins, {col=i, lo=x,hi=x, has=stats}) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> bins <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.score</span><span class="hljs-params">(i,goal,tmp)</span></span>
  <span class="hljs-keyword">local</span> goals={}
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goals.smile</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> r&gt;b <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> b*b/(b+r +<span class="hljs-number">1E-31</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goals.frown</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> b&lt;r <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> r*r/(b+r +<span class="hljs-number">1E-31</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goals.xplor</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>/(b+r                +<span class="hljs-number">1E-31</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goals.doubt</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>/(<span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(b-r)      +<span class="hljs-number">1E-31</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> best, rest = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> x==goal <span class="hljs-keyword">then</span> best = best+n/i.n <span class="hljs-keyword">else</span> rest = rest+n/i.n <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> best + rest &lt; <span class="hljs-number">0.01</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> goals[YOUR.goal](best,rest) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h2 id="tricks">Tricks</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h3 id="generate-your-from-help-string">Generate <code>YOUR</code> from <code>help</code> String</h3>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Matches for relevant lines
See if we need to update <code>flag</code> from command line.<br>Note two tricks:<br>(1) We can use abbreviations on command line.<br>    E.g. <code>-s</code> can match the flag <code>seed</code>.<br>(2) If command line  mentions a boolean flag, this<br>    code flips the default value for that boolean.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">options</span><span class="hljs-params">(help_string)</span></span>
  <span class="hljs-keyword">local</span> t,update_from_cli  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update_from_cli</span><span class="hljs-params">(flag,x)</span></span> 
    <span class="hljs-keyword">for</span> n,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span>         
      <span class="hljs-keyword">if</span>   flag:<span class="hljs-built_in">match</span>(<span class="hljs-string">&quot;^&quot;</span>..txt:<span class="hljs-built_in">sub</span>(<span class="hljs-number">2</span>)..<span class="hljs-string">&quot;.*&quot;</span>) <span class="hljs-comment">-- allow abbreviations for flags</span>
      <span class="hljs-keyword">then</span> x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    t[flag] = coerce(x) <span class="hljs-keyword">end</span>

  t={}
  help_string:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n  [-]([^%s]+)[^\n]*%s([^%s]+)&quot;</span>, update_from_cli) 
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Convert a string <code>x</code> to its correct type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">coerce</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <ul>
<li>Table Stuff</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span>    <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(t,x); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firsts</span><span class="hljs-params">(a,b)</span></span>  <span class="hljs-keyword">return</span> a[<span class="hljs-number">1</span>] &lt; b[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span>    <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f);   <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f,  u)</span></span> 
  u={};<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> push(u,f(v)) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slots</span><span class="hljs-params">(t,   u)</span></span> 
  u={}
  <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) ~= <span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">then</span> push(u,k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(u) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span><span class="hljs-params">(t,u)</span></span> 
  u={}
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[k]=v <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(u, <span class="hljs-built_in">getmetatable</span>(t)) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(file,   x,row)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">row</span><span class="hljs-params">(x,  t)</span></span>
     <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> x:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;%s+&quot;</span>,<span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">gmatch</span><span class="hljs-string">&quot;([^,]+)&quot;</span> <span class="hljs-keyword">do</span> push(t,coerce(y)) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
   file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(file) 
   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span> x=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
                     <span class="hljs-keyword">if</span> x <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> row(x,{}) <span class="hljs-keyword">else</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(file) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">green</span><span class="hljs-params">(s)</span></span>  <span class="hljs-keyword">return</span> #s&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;\027[32m&quot;</span>..s..<span class="hljs-string">&quot;\027[0m&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">yellow</span><span class="hljs-params">(s)</span></span>  <span class="hljs-keyword">return</span> #s&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;\027[33m&quot;</span>..s..<span class="hljs-string">&quot;\027[0m&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(x,d,  n)</span></span> n=<span class="hljs-number">10</span>^(d <span class="hljs-keyword">or</span> YOUR.round); <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x*n+<span class="hljs-number">0.5</span>)/n <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnds</span><span class="hljs-params">(t,d)</span></span>
  <span class="hljs-keyword">return</span> map(t,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(x)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> rnd(x,d) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>

fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span><span class="hljs-params">(...)</span></span> <span class="hljs-keyword">if</span> YOUR.verbose <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(fmt(...)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,   u,key)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">key</span><span class="hljs-params">(k)</span></span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>, yellow(k), o(t[k])) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  u = #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> map(t,o) <span class="hljs-keyword">or</span> map(slots(t),key)
  <span class="hljs-keyword">return</span> green((t._is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>))..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(u, <span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rand</span><span class="hljs-params">(lo,hi)</span></span>
  YOUR.seed = (<span class="hljs-number">16807</span> * YOUR.seed) % <span class="hljs-number">2147483647</span>
  <span class="hljs-keyword">return</span> (lo <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) + ((hi <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) - (lo <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)) * YOUR.seed / <span class="hljs-number">2147483647</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randi</span><span class="hljs-params">(lo,hi)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(<span class="hljs-number">0.5</span> + rand(lo,hi)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p><strong>any(t: list, n?:int) : (any | list)</strong><br>If called with one argument, return any item picked at random.
If called with two arguements, reutrn that maany <code>any</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">any</span><span class="hljs-params">(t,  n)</span></span> 
  <span class="hljs-keyword">if</span> n <span class="hljs-keyword">then</span> u={};<span class="hljs-keyword">for</span> j=<span class="hljs-number">1</span>,n <span class="hljs-keyword">do</span> push(u,any(t)) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u 
       <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> t[randi(<span class="hljs-number">1</span>,#t)] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p><strong>shuffle(t: list) : list</strong><br>Random shuffles top-level of <code>t</code>. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(t,   j)</span></span>
  <span class="hljs-keyword">for</span> i=#t,<span class="hljs-number">2</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> j=randi(<span class="hljs-number">1</span>,i); t[i],t[j]=t[j],t[i] <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <ul>
<li><h3 id="maths-stuff">Maths stuff</h3>
</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p><strong>xpect(a=(NUM|SYM), b=(NUM|SYM)) : num</strong><br>Sum of diversities, weighted by population size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xpect</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> (a.n*a:div()+ b.n*b:div())/(a.n+b.n) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h3 id="oo-stuff">OO stuff</h3>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p><strong>ako(x:klass) : klass</strong><br>To test for class type, use e.g. <code>ako(X)==NUM</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ako</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">getmetatable</span>(x) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>Instance creation; e.g. <code>new(NUM,{n=0})</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(mt,x)</span></span> 
  MINE.oid=MINE.oid+<span class="hljs-number">1</span>; x._oid=MINE.oid <span class="hljs-comment">-- Everyone gets a unique id.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(x,mt) <span class="hljs-keyword">end</span>        <span class="hljs-comment">-- Methods now delegate to `mt`.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <h2 id="demos">Demos</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p><code>go,nogo</code> are places to store demos (and disables demos).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> go, nogo = MINE.go, MINE.nogo</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Show config options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">(s)</span></span>    say(o(YOUR)) <span class="hljs-keyword">end</span> <span class="hljs-comment">-- to disable, change &quot;go&quot; to &quot;nogo&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Testing if tests work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.pass</span><span class="hljs-params">(s)</span></span>   azzert(<span class="hljs-literal">true</span>,  <span class="hljs-string">&quot;can you handle success?&quot;</span>)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Test we can handle failing tests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nogo.fail</span><span class="hljs-params">(s)</span></span> azzert(<span class="hljs-literal">false</span>,<span class="hljs-string">&quot;can you handle failure?&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p>Can we read data from a disk file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.sample</span><span class="hljs-params">(s,  egs)</span></span> 
  s=SAMPLE(YOUR.file)
  azzert(<span class="hljs-number">398</span>==#s.egs, <span class="hljs-string">&quot;got enough rows?&quot;</span>)
  azzert(s.ys[<span class="hljs-number">1</span>].w==<span class="hljs-number">-1</span>,<span class="hljs-string">&quot;minimizing goals are -1?&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Generate a new table, with the same structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.clone</span><span class="hljs-params">(s,  t,s1,s2)</span></span> 
  s=SAMPLE(YOUR.file)
  s1=o(s.ys)
  t=s:clone(s.egs) 
  s2=o(t.ys) 
  azzert(s1==s2, <span class="hljs-string">&quot;cloning works?&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>Numbers demi</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.num</span><span class="hljs-params">( m,n)</span></span>
  m=NUM()
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10</span> <span class="hljs-keyword">do</span> m:add(i) <span class="hljs-keyword">end</span>
  n = copy(m)
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10</span> <span class="hljs-keyword">do</span> n:add(i) <span class="hljs-keyword">end</span>
  azzert(<span class="hljs-number">2.95</span> == rnd(n:div()),<span class="hljs-string">&quot;sd ok?&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>Checking we can sort on multiple goals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.dominate</span><span class="hljs-params">(s,  egs)</span></span> 
  s=SAMPLE(YOUR.file)
  egs = <span class="hljs-built_in">sort</span>(s.egs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a:better(b,s) <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">5</span> <span class="hljs-keyword">do</span> say(o(egs[i]:cols(s.ys))) <span class="hljs-keyword">end</span>; say(<span class="hljs-string">&quot;&quot;</span>)
  <span class="hljs-keyword">for</span> i=#egs<span class="hljs-number">-5</span>,#egs <span class="hljs-keyword">do</span> say(o(egs[i]:cols(s.ys))) <span class="hljs-keyword">end</span>
  azzert(egs[<span class="hljs-number">1</span>]:better(egs[#egs],s), <span class="hljs-string">&quot;y-sort working?&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>Checking if distances stuff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.distance</span><span class="hljs-params">(   s,eg1,dist,tmp,j1,j2,d1,d2,one)</span></span>
  s=SAMPLE(YOUR.file)
  eg1=s.egs[<span class="hljs-number">1</span>]
  dist = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eg2)</span></span> <span class="hljs-keyword">return</span> {eg2,eg1:dist(eg2,s)} <span class="hljs-keyword">end</span>
  tmp  = <span class="hljs-built_in">sort</span>(map(s.egs, dist), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[<span class="hljs-number">2</span>] &lt; b[<span class="hljs-number">2</span>] <span class="hljs-keyword">end</span>)
  one = tmp[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">1</span>,<span class="hljs-number">30</span> <span class="hljs-keyword">do</span>
    j1=randi(<span class="hljs-number">1</span>,#tmp)
    j2=randi(<span class="hljs-number">1</span>,#tmp)
    <span class="hljs-keyword">if</span> j1&gt;j2 <span class="hljs-keyword">then</span> j1,j2=j2,j1 <span class="hljs-keyword">end</span>
    d1 = tmp[j1][<span class="hljs-number">1</span>]:dist(one,s)
    d2 = tmp[j2][<span class="hljs-number">1</span>]:dist(one,s)
    azzert(d1 &lt;= d2,<span class="hljs-string">&quot;distance ?&quot;</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p>Demo of main functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.tussle</span><span class="hljs-params">(   s,x)</span></span>
  s = SAMPLE(YOUR.file)
  s:tussling()
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <h2 id="start-up">Start up</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p>Lost the “public” tests (those with lower case names), </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.LS</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(slots(go)) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> k:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^[a-z]&quot;</span> <span class="hljs-keyword">then</span>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  -t &quot;</span>..k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p>Run the “public” tests (those with lower case names), </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.ALL</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(slots(go)) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> k:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^[a-z]&quot;</span> <span class="hljs-keyword">then</span> 
      YOUR = options(MINE.help)  
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span>..k)
      go[k]() <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p>Initialize failure count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MINE.fails=<span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <p><strong>azzert(test:bool, msg:str) : nil</strong><br>Wrapper around the assert function.<br>[1] Updates the failure counts.<br>[2] Only call the real <code>assert</code> if `-debug” on cli.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">azzert</span><span class="hljs-params">(test,msg)</span></span> 
  msg=msg <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-keyword">if</span> test <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  PASS : &quot;</span>..msg) 
          <span class="hljs-keyword">else</span> MINE.fails = MINE.fails+<span class="hljs-number">1</span>                       <span class="hljs-comment">-- [1]</span>
               <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  FAIL : &quot;</span>..msg)
               <span class="hljs-keyword">if</span> YOUR.Debug <span class="hljs-keyword">then</span> <span class="hljs-built_in">assert</span>(test,msg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-comment">-- [2]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p><strong>main(help:txt) : nil</strong><br>[1] Build <code>YOUR</code> from the help string.<br>[2] Maybe print the help text.<br>[3] Run the <code>todo</code> function.<br>[4] Hunt for any stray globals.<br>[5] Return the number of fails generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span><span class="hljs-params">(help)</span></span>  
  YOUR = options(MINE.help)                                  <span class="hljs-comment">-- [1] </span>
  <span class="hljs-keyword">if</span> YOUR.h <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(MINE.help); <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>() <span class="hljs-keyword">end</span>             <span class="hljs-comment">-- [2]</span>
  <span class="hljs-keyword">if</span> YOUR.todo <span class="hljs-keyword">and</span> go[YOUR.todo] <span class="hljs-keyword">then</span> go[YOUR.todo]() <span class="hljs-keyword">end</span>    <span class="hljs-comment">-- [3]</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span>                                  <span class="hljs-comment">-- [4]</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> MINE.b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Rogue?&quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(MINE.fails) <span class="hljs-keyword">end</span>                                    <span class="hljs-comment">-- [5]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p>Let’s go.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>main(MINE.help)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
