<!DOCTYPE html>

<html>
<head>
  <title>l5.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>l5.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=v <span class="hljs-keyword">end</span> <span class="hljs-comment">--[[
           _  _  _    _    _           _  _  _                        
  __ _    | |(_)| |_ | |_ | |  ___    | |(_)| |_  ___                 
 / _` |   | || || __|| __|| | / _ \   | || || __|/ _ \                
| (_| |   | || || |_ | |_ | ||  __/   | || || |_|  __/                
 \__,_|   |_||_| \__| \__||_| \___|   |_||_| \__|\___|                
   __           _        _                            _               
  / /  /\ /\   /_\      | |  ___   __ _  _ __  _ __  (_) _ __    __ _ 
 / /  / / \ \ //_\\     | | / _ \ / _` || &#x27;__|| &#x27;_ \ | || &#x27;_ \  / _` |
/ /___\ \_/ //  _  \    | ||  __/| (_| || |   | | | || || | | || (_| |
\____/ \___/ \_/ \_/    |_| \___| \__,_||_|   |_| |_||_||_| |_| \__, |
 _  _  _                                                        |___/ 
| |(_)| |__   _ __  __ _  _ __  _   _                                 
| || || &#x27;_ \ | &#x27;__|/ _` || &#x27;__|| | | |                                
| || || |_) || |  | (_| || |   | |_| |                                
|_||_||_.__/ |_|   \__,_||_|    \__, |                                
                                |___/     -]]</span> <span class="hljs-keyword">local</span> options={ 

what = <span class="hljs-string">&quot;Small sample multi-objective optimizer.&quot;</span>,
usage= <span class="hljs-string">&quot;(c) 2021 Tim Menzies &lt;timm@ieee.org&gt; unlicense.org&quot;</span>,
about= <span class="hljs-string">[[
Sort N examples on multi-goals using a handful of &#x27;hints&#x27;; i.e.

- Evaluate and rank, a few examples (on their y-values);
- Sort other examples by x-distance to the ranked ones;
- Recurse on the better half (so we sample more and more
  from the better half, then quarter, then eighth...).

A regression tree learner then explores the examples (sorted
left to right, worst to best).  By finding branches that
reduce the variance of the index of those examples, this
tree reports what attribute ranges select for the better (or
worse) examples.  ]]</span>,

how= {{<span class="hljs-string">&quot;file&quot;</span>,     <span class="hljs-string">&quot;-f&quot;</span>,  <span class="hljs-string">&quot;../../data/auto93.csv&quot;</span>,  <span class="hljs-string">&quot;read data from file&quot;</span>},
      {<span class="hljs-string">&quot;help&quot;</span>,     <span class="hljs-string">&quot;-h&quot;</span>,  <span class="hljs-literal">false</span>  ,<span class="hljs-string">&quot;show help&quot;</span>                 },
      {<span class="hljs-string">&quot;hints&quot;</span>,    <span class="hljs-string">&quot;-H&quot;</span>,  <span class="hljs-number">4</span>      ,<span class="hljs-string">&quot;hints per generation&quot;</span>      },
      {<span class="hljs-string">&quot;p&quot;</span>,        <span class="hljs-string">&quot;-p&quot;</span>,  <span class="hljs-number">2</span>      ,<span class="hljs-string">&quot;distance calc exponent&quot;</span>    },
      {<span class="hljs-string">&quot;small&quot;</span>,    <span class="hljs-string">&quot;-s&quot;</span>,  <span class="hljs-number">.5</span>     ,<span class="hljs-string">&quot;div list t into t^small&quot;</span>   },
      {<span class="hljs-string">&quot;seed&quot;</span>,     <span class="hljs-string">&quot;-S&quot;</span>,  <span class="hljs-number">10019</span>  ,<span class="hljs-string">&quot;random number seed&quot;</span>        },
      {<span class="hljs-string">&quot;train&quot;</span>,    <span class="hljs-string">&quot;-t&quot;</span>,  <span class="hljs-number">.5</span>     ,<span class="hljs-string">&quot;size of training set&quot;</span>      },
      {<span class="hljs-string">&quot;trivial&quot;</span>,  <span class="hljs-string">&quot;-T&quot;</span>,  <span class="hljs-number">.35</span>    ,<span class="hljs-string">&quot;small delta=trivial*sd&quot;</span>    },
      {<span class="hljs-string">&quot;todo&quot;</span>,     <span class="hljs-string">&quot;-T&quot;</span>,  <span class="hljs-string">&quot;all&quot;</span>  ,<span class="hljs-string">&quot;run unit test, or &#x27;all&#x27;&quot;</span>   },
      {<span class="hljs-string">&quot;wild&quot;</span>,     <span class="hljs-string">&quot;-W&quot;</span>,  <span class="hljs-literal">false</span>  ,<span class="hljs-string">&quot;run tests, no protection&quot;</span>  }}}

<span class="hljs-keyword">local</span> fmt,help,cli,the
fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Pretty print help text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">help</span><span class="hljs-params">(opt)</span></span>
  <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;\n%s [OPTIONS]\n%s\n%s\n\nOPTIONS:\n&quot;</span>,<span class="hljs-built_in">arg</span>[<span class="hljs-number">0</span>],opt.usage,opt.what))
  <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(opt.how) <span class="hljs-keyword">do</span> <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;%4s %-9s%s\t%s %s&quot;</span>,
            t[<span class="hljs-number">2</span>], t[<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span> t[<span class="hljs-number">1</span>] <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>, t[<span class="hljs-number">4</span>], t[<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span><span class="hljs-string">&quot;=&quot;</span> <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>, t[<span class="hljs-number">3</span>] <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)) <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span>..opt.about); <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>() <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>Update any “-x” flag with “-x” arguments from the command line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cli</span><span class="hljs-params">(opt,   u)</span></span> 
  u={}
  <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(opt.how) <span class="hljs-keyword">do</span>
    u[t[<span class="hljs-number">1</span>]] = t[<span class="hljs-number">3</span>]
    <span class="hljs-keyword">for</span> n,word <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> word==t[<span class="hljs-number">2</span>] <span class="hljs-keyword">then</span>
      u[t[<span class="hljs-number">1</span>]] = t[<span class="hljs-number">3</span>] <span class="hljs-keyword">and</span> (<span class="hljs-built_in">tonumber</span>(<span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>]) <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>]) <span class="hljs-keyword">or</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> u.help <span class="hljs-keyword">then</span> help(opt) <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(u.seed <span class="hljs-keyword">or</span> <span class="hljs-number">100019</span>)
  <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Make a global for our options e.g. the = {seed=10019, help=false, p=2…}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>the = cli(options)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <pre><code>      _                      _     _   _      
</code></pre>
<p>  _ __   (<em>)  ___  __     _  _  | |</em>  (<em>) | |  ___
 | ‘  \  | | (</em>-&lt; / <em>|   | || | |  <em>| | | | | (</em>-&lt;
 |</em>|<em>|</em>| |<em>| /__/ _</em>|    _,<em>|  _</em>| |<em>| |</em>| /__/    </p>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h2 id="table-stuff">Table Stuff</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> cat,map,lap,keys, last,copy,pop,push,<span class="hljs-built_in">sort</span>,firsts,first,second,shuffle,bchop</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Table to string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cat     = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Return a sorted table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">sort</span>    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Add to end, pull from end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>push    = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>
pop     = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">remove</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Return first,second, last  item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>first   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> t[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>
second  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> t[<span class="hljs-number">2</span>] <span class="hljs-keyword">end</span>
last    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> t[#t] <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Function for sorting pairs of items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>firsts  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> first(a) &lt; first(b) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Random order of items in a list (sort in place).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(t,   j)</span></span>
  <span class="hljs-keyword">for</span> i=#t,<span class="hljs-number">2</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> j=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>(<span class="hljs-number">1</span>,i); t[i],t[j]=t[j],t[i] <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Collect values, passed through ‘f’.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lap</span><span class="hljs-params">(t,f)</span></span>  <span class="hljs-keyword">return</span> map(t,f,<span class="hljs-number">1</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Collect key,values, passed through ‘f’.<br>If <code>f</code> returns two values, store as key,value.<br>If <code>f</code> returns one values, store at index value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f,one,     u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> x,y <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> one <span class="hljs-keyword">then</span> x,y=f(y) <span class="hljs-keyword">else</span> x,y=f(x,y) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> x ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> y <span class="hljs-keyword">then</span> u[x]=y <span class="hljs-keyword">else</span> u[<span class="hljs-number">1</span>+#u]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Return a table’s keys (sorted).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">keys</span><span class="hljs-params">(t,u)</span></span>
  u={}
  <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)~=<span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">then</span> push(u,k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(u) 
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Binary chop (assumes sorted lists)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bchop</span><span class="hljs-params">(t,val,lt,lo,hi,     mid)</span></span>
  lt = lt <span class="hljs-keyword">or</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> x &lt; y <span class="hljs-keyword">end</span>
  lo,hi = lo <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>, hi <span class="hljs-keyword">or</span> #t
  <span class="hljs-keyword">while</span> lo &lt;= hi <span class="hljs-keyword">do</span>
    mid =(lo+hi) // <span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> lt(t[mid],val) <span class="hljs-keyword">then</span> lo=mid+<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> hi= mid<span class="hljs-number">-1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(lo,#t)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <h2 id="maths-stuff">Maths Stuff</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-built_in">abs</span>,norm,sum,rnd,rnds
<span class="hljs-built_in">abs</span> = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Round <code>x</code> to <code>d</code> decimal places.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(x,d,  n)</span></span> 
  n=<span class="hljs-number">10</span>^(d <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>); <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x*n+<span class="hljs-number">0.5</span>) / n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Round list of items to  <code>d</code> decimal places.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnds</span><span class="hljs-params">(t,d)</span></span> 
  <span class="hljs-keyword">return</span> lap(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> rnd(x,d <span class="hljs-keyword">or</span> <span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> ) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Sum items, filtered through <code>f</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sum</span><span class="hljs-params">(t,f)</span></span>
  f= f <span class="hljs-keyword">or</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  out=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(f) <span class="hljs-keyword">do</span> out = out + f(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h2 id="printing-stuff">Printing Stuff</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> out,shout,red,green,yellow,blue</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>Print as red, green, yellow, blue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">red</span><span class="hljs-params">(s)</span></span>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\27[1m\27[31m&quot;</span>..s..<span class="hljs-string">&quot;\27[0m&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">green</span><span class="hljs-params">(s)</span></span>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\27[1m\27[32m&quot;</span>..s..<span class="hljs-string">&quot;\27[0m&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">yellow</span><span class="hljs-params">(s)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\27[1m\27[33m&quot;</span>..s..<span class="hljs-string">&quot;\27[0m&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blue</span><span class="hljs-params">(s)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\27[1m\27[36m&quot;</span>..s..<span class="hljs-string">&quot;\27[0m&quot;</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>Printed string from a nested structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>shout= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-built_in">print</span>(out(x)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>Generate string from a nested structures
(and don’t print any contents more than once).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">out</span><span class="hljs-params">(t,seen,    u,key,value,public)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">key</span><span class="hljs-params">(k)</span></span>   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,blue(k),out(t[k],seen)) <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">value</span><span class="hljs-params">(v)</span></span> <span class="hljs-keyword">return</span> out(v,seen) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) == <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;(...)&quot;</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span>    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  seen = seen <span class="hljs-keyword">or</span> {}
  <span class="hljs-keyword">if</span> seen[t] <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;...&quot;</span> <span class="hljs-keyword">else</span> seen[t] = t <span class="hljs-keyword">end</span>
  u = #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> lap(t, value) <span class="hljs-keyword">or</span> lap(keys(t), key) 
  <span class="hljs-keyword">return</span> red((t._is <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>)..cat(u,<span class="hljs-string">&quot; &quot;</span>)..red(<span class="hljs-string">&quot;}&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h2 id="file-io-stuff">File i/o Stuff</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Return one table per line, split on commans.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> csv
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(file,   line)</span></span>
  file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(file)
  line = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(   t,tmp)</span></span>
    <span class="hljs-keyword">if</span> line <span class="hljs-keyword">then</span>
      t={}
      <span class="hljs-keyword">for</span> cell <span class="hljs-keyword">in</span> line:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;[\t\r ]*&quot;</span>,<span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;#.*&quot;</span>,<span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span>
        push(t, <span class="hljs-built_in">tonumber</span>(cell) <span class="hljs-keyword">or</span> cell) <span class="hljs-keyword">end</span> 
      line = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
      <span class="hljs-keyword">if</span> #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(file) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <h2 id="oo-stuff">OO Stuff</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> has,obj</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Create an instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">(mt,x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(x,mt) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>Create a clss</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(s, o,new)</span></span>
   o = {_is=s, <span class="hljs-built_in">__tostring</span>=out}
   o.<span class="hljs-built_in">__index</span> = o
   <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(o,{<span class="hljs-built_in">__call</span> = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,...)</span></span> <span class="hljs-keyword">return</span> o.new(...) <span class="hljs-keyword">end</span>}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <h2 id="stuff-for-tracking-symbol-counts">Stuff for tracking <code>Sym</code>bol Counts.</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><code>Sym</code>s track symbol counts and the <code>mode</code> (most frequent symbol).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Sym=obj<span class="hljs-string">&quot;Sym&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym.new</span><span class="hljs-params">(inits,     self)</span></span> 
  <span class="hljs-built_in">self</span>= has(Sym,{has={}, n=<span class="hljs-number">0</span>, mode=<span class="hljs-literal">nil</span>, most=<span class="hljs-number">0</span>})
  <span class="hljs-keyword">for</span> _,one <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(one) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:add</span><span class="hljs-params">(x)</span></span> 
  <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
  <span class="hljs-built_in">self</span>.has[x] = <span class="hljs-number">1</span> + (<span class="hljs-built_in">self</span>.has[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.has[x] &gt; <span class="hljs-built_in">self</span>.most <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.most, <span class="hljs-built_in">self</span>.mode = <span class="hljs-built_in">self</span>.has[x], x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mode <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <h2 id="stuff-for-tracking-numbers">Stuff for tracking <code>Num</code>bers.</h2>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><code>Num</code>s track a list of number, and can report  it sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Num=obj<span class="hljs-string">&quot;Num&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num.new</span><span class="hljs-params">(inits,     self)</span></span> 
  <span class="hljs-built_in">self</span>= has(Num,{has={}, n=<span class="hljs-number">0</span>, lo=<span class="hljs-number">1E32</span>, hi =<span class="hljs-number">1E-32</span>, ready=<span class="hljs-literal">true</span>})
  <span class="hljs-keyword">for</span> _,one <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(one) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:add</span><span class="hljs-params">(x)</span></span> 
  <span class="hljs-keyword">if</span>     x&gt;<span class="hljs-built_in">self</span>.hi <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.hi = x 
  <span class="hljs-keyword">elseif</span> x&lt;<span class="hljs-built_in">self</span>.lo <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.lo = x <span class="hljs-keyword">end</span>
  push(<span class="hljs-built_in">self</span>.has,x); <span class="hljs-built_in">self</span>.n=<span class="hljs-built_in">self</span>.n+<span class="hljs-number">1</span>; <span class="hljs-built_in">self</span>.ready=<span class="hljs-literal">false</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p>Ensure that the returned list of numbers is sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:all</span><span class="hljs-params">(x)</span></span> 
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.ready <span class="hljs-keyword">then</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.has) <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">self</span>.ready = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.has <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <p>Combine two <code>num</code>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:merge</span><span class="hljs-params">(other,    new)</span></span>
  new = Num.new(<span class="hljs-built_in">self</span>.has)
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(other.has) <span class="hljs-keyword">do</span> new:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p>Return a merged item if that combination 
is simpler than its parts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:mergeable</span><span class="hljs-params">(other,    new,b4)</span></span>
  new = <span class="hljs-built_in">self</span>:merge(other)
  b4  = (<span class="hljs-built_in">self</span>.n*<span class="hljs-built_in">self</span>:sd() + other.n*other:sd()) / new.n
  <span class="hljs-keyword">if</span> b4 &gt;= new:sd() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p>The <code>mid</code> is the 50th percentile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:per(<span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p>Return <code>x</code> normalized 0..1, lo..hi.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:norm</span><span class="hljs-params">(x,     lo,hi)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  lo,hi = <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(hi - lo) &lt; <span class="hljs-number">1E-32</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x - lo)/(hi - lo) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p>Return the <code>p</code>-th percentile number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:per</span><span class="hljs-params">(p,    t)</span></span>
  t = <span class="hljs-built_in">self</span>:all()
  p = p*#t//<span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> #t&lt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> t[<span class="hljs-number">1</span>] <span class="hljs-keyword">or</span> t[p &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> p&gt;#t <span class="hljs-keyword">and</span> #t <span class="hljs-keyword">or</span> p] <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>The 10th to 90th percentile is 2.56 times the standard deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:sd</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> (<span class="hljs-built_in">self</span>:per(<span class="hljs-number">.9</span>) - <span class="hljs-built_in">self</span>:per(<span class="hljs-number">.1</span>))/ <span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p>Samples store examples. Samples know about 
(a) lo,hi ranges on the numerics
and (b) what  are independent <code>x</code> or dependent <code>y</code> columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Sample=obj<span class="hljs-string">&quot;Sample&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample.new</span><span class="hljs-params">(     src,self)</span></span>
  <span class="hljs-built_in">self</span> = has(Sample,{names=<span class="hljs-literal">nil</span>, all={}, ys={}, xs={}, egs={}})  
  <span class="hljs-keyword">if</span> src <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> x   <span class="hljs-keyword">in</span> csv(src) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(x)   <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(x) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:clone</span><span class="hljs-params">(      inits,out)</span></span> 
  out = Sample.new():add(<span class="hljs-built_in">self</span>.names) 
  <span class="hljs-keyword">for</span> _,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> out:add(eg) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:add</span><span class="hljs-params">(eg,     name,datum)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span><span class="hljs-params">(col,new,    weight, where, what)</span></span> 
    <span class="hljs-keyword">if</span> new:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">end</span>
    weight= new:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    what  = {col=col, w=weight, seen=(new:<span class="hljs-built_in">match</span>(<span class="hljs-string">&quot;^[A-Z]&quot;</span>,x) <span class="hljs-keyword">and</span> Num() <span class="hljs-keyword">or</span> Sym())}
    where = (new:<span class="hljs-built_in">find</span>(<span class="hljs-string">&quot;+&quot;</span>) <span class="hljs-keyword">or</span> new:<span class="hljs-built_in">find</span>(<span class="hljs-string">&quot;-&quot;</span>)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.ys <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.xs
    push(<span class="hljs-built_in">self</span>.all, what)
    push(where,    what)
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-----------------</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">datum</span><span class="hljs-params">(one,new)</span></span>
    <span class="hljs-keyword">if</span> new ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> one.seen:add(new) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-----------------</span>
  <span class="hljs-keyword">if</span>   <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.names
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.names = eg
       map(eg, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col,x)</span></span> name(col,x) <span class="hljs-keyword">end</span>) 
  <span class="hljs-keyword">else</span> push(<span class="hljs-built_in">self</span>.egs, eg)
       map(<span class="hljs-built_in">self</span>.all, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,col)</span></span> datum(col,eg[col.col]) <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:stats</span><span class="hljs-params">(cols)</span></span>
  <span class="hljs-keyword">return</span> lap(cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.ys,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col)</span></span> <span class="hljs-keyword">return</span> col.seen:mid() <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p>bins his
bins sorts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:tree</span><span class="hljs-params">(min,      node,min,sub)</span></span>
  node = {node=<span class="hljs-built_in">self</span>, kids={}}
  <span class="hljs-built_in">min</span> = <span class="hljs-built_in">min</span>  <span class="hljs-keyword">or</span> (#<span class="hljs-built_in">self</span>.egs)^the.small
  <span class="hljs-keyword">if</span> #<span class="hljs-built_in">self</span>.egs &gt;= <span class="hljs-number">2</span>*<span class="hljs-built_in">min</span> <span class="hljs-keyword">then</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <ul>
<li>here</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> _,span <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(splits.best(sample)) <span class="hljs-keyword">do</span>
      <span class="hljs-built_in">sub</span> = <span class="hljs-built_in">self</span>:clone()
      <span class="hljs-keyword">for</span> _,at <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(span.has) <span class="hljs-keyword">do</span> <span class="hljs-built_in">sub</span>:add(<span class="hljs-built_in">self</span>.egs[at]) <span class="hljs-keyword">end</span> 
      push(node.kids, span) 
      span.has = <span class="hljs-built_in">sub</span>:tree(<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> node <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <p>at node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sample:where</span><span class="hljs-params">(tree,eg,    max,x,default)</span></span>
  <span class="hljs-keyword">if</span> #kid.has==<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> tree <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">max</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,kid <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(tree.node) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> #kid.has &gt; <span class="hljs-built_in">max</span> <span class="hljs-keyword">then</span> default,<span class="hljs-built_in">max</span> = kid,#kid.has <span class="hljs-keyword">end</span>
    x = eg[kid.col]
    <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> x &lt;= kid.hi <span class="hljs-keyword">and</span> x &gt;= kid.lo <span class="hljs-keyword">then</span> 
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:where(kid.has.eg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:where(default, eg) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <p>doscretization tricks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> splits={}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splits.best</span><span class="hljs-params">(sample,    best,tmp,xpect,out)</span></span>
  best = maths.<span class="hljs-built_in">huge</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sample.xs) <span class="hljs-keyword">do</span>
    tmp, xpect = splits.whatif(x.at,<span class="hljs-built_in">self</span>)
    <span class="hljs-keyword">if</span>   xpect &lt; best 
    <span class="hljs-keyword">then</span> out,best = tmp,xpect <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splits.whatif</span><span class="hljs-params">(col,sample,     out)</span></span>
  out   = splits.spans(col,sample)
  xpect = sum(out, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x.has.n*x:sd() <span class="hljs-keyword">end</span>)/#sample.egs 
  out   = map(out, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,x)</span></span> x.has=x.has:all(); x.col= col <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">return</span> out, xpect <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splits.spans</span><span class="hljs-params">(col,sample,      xs, symbolic,x)</span></span>
  xys,xs,  symbolic ={}, Num(), sample.nums[col]
  <span class="hljs-keyword">for</span> rank,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sample.egs) <span class="hljs-keyword">do</span>
    x = eg[col]
    <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
      xs:add(x)
      <span class="hljs-keyword">if</span>   symbolic
      <span class="hljs-keyword">then</span> <span class="hljs-comment">-- in symbolic columns, xys are the indexes seen with each symbol</span>
        xys[x] = xys[x] <span class="hljs-keyword">or</span> {}
        push(xys[x], rank) 
      <span class="hljs-keyword">else</span> <span class="hljs-comment">-- in numeric columns,  xys are each number paired with its row id</span>
        push(xys, {x=x,y=rank}) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span>   symbolic 
  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> map(xys, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x,t)</span></span> <span class="hljs-keyword">return</span> {lo=x, hi=x, has=Num(t)} <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> splits.merge(
                splits.div(xys, #xs^the.small, sd(<span class="hljs-built_in">sort</span>(xs))*the.trivial)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <p>Generate a new range when     </p>
<ol>
<li>there is enough left for at least one more range; and     </li>
<li>the lo,hi delta in current range is not boringly small; and    </li>
<li>there are enough x values in this range; and   </li>
<li>there is natural split here
Fuse adjacent ranges when:</li>
<li>the combined class distribution of two adjacent ranges 
is just as simple as the parts.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splits.div</span><span class="hljs-params">(xys, tiny, dull,           now,out,x,y)</span></span>
  xys = <span class="hljs-built_in">sort</span>(xys, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a.x &lt; b.x <span class="hljs-keyword">end</span>)
  now = {lo=xys[<span class="hljs-number">1</span>].x, hi=xys[<span class="hljs-number">1</span>].x, has=Num()}
  out = {now}
  <span class="hljs-keyword">for</span> j,xy <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(xys) <span class="hljs-keyword">do</span>
    x, y = xy.x, xy.y
    <span class="hljs-keyword">if</span>   j&lt;#xys-tiny <span class="hljs-keyword">and</span> x~=xys[j+<span class="hljs-number">1</span>].x <span class="hljs-keyword">and</span> now.has.n&gt;tiny <span class="hljs-keyword">and</span> now.hi-now.lo&gt;dull 
    <span class="hljs-keyword">then</span> now = {lo=x, hi=x, has=Num()}
         push(out, now) <span class="hljs-keyword">end</span> 
    now.hi = x 
    now.has:add(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splits.merge</span><span class="hljs-params">(b4,       j,tmp,a,n,hasnew)</span></span> 
  j, n, tmp = <span class="hljs-number">0</span>, #b4, {}
  <span class="hljs-keyword">while</span> j&lt;n <span class="hljs-keyword">do</span>
    j = j + <span class="hljs-number">1</span>
    a = b4[j]
    <span class="hljs-keyword">if</span> j &lt; n<span class="hljs-number">-1</span> <span class="hljs-keyword">then</span>
      better = a.has:mergeable(b4[j+<span class="hljs-number">1</span>].has)
      <span class="hljs-keyword">if</span> better <span class="hljs-keyword">then</span> 
        j = j + <span class="hljs-number">1</span> 
        a = {lo=a.lo, hi= b4[j+<span class="hljs-number">1</span>].hi, has=better} <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    push(tmp,a) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> #tmp==#b4 <span class="hljs-keyword">and</span> b4 <span class="hljs-keyword">or</span> merge(tmp) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <p>ordered object
per sd add sort here. mergabe</p>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <p>geometry tricks
y column rankings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> dist, better,betters
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist</span><span class="hljs-params">(eg1,eg2,sample,     a,b,d,n,inc,dist1)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist1</span><span class="hljs-params">(num,a,b)</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> num <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> a==b <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span>     a==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> b=norm(b, num.lo, num,hi); a = b&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">elseif</span> b==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> a=norm(a, num.lo, num.hi); b = a&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>   a,b = norm(a, num.lo, num.hi), norm(b, num.lo, num.hi)
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(a-b) 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------------------</span>
  d,n=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sample.xs) <span class="hljs-keyword">do</span>
    a,b = eg1[x.col], eg2[x.col]
    inc = a==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> b==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> dist1(x._is==<span class="hljs-string">&quot;Num&quot;</span>,a,b)
    d   = d + inc^the.p
    n   = n + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/n)^(<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">betters</span><span class="hljs-params">(egs,sample)</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(egs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> better(a,b,sample) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">better</span><span class="hljs-params">(eg1,eg2,sample,     e,n,a,b,s1,s2)</span></span>
  n,s1,s2,e = #sample.ys, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.71828</span>
  <span class="hljs-keyword">for</span> _,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sample.ys) <span class="hljs-keyword">do</span>
    a  = num.seen:norm(eg1[num.col])
    b  = num.seen:norm(eg2[num.col])
    s1 = s1 - e^(num.w * (a-b)/n) 
    s2 = s2 - e^(num.w * (b-a)/n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/n &lt; s2/n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p>sample sample sorting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> hints={}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hints.default</span><span class="hljs-params">(eg)</span></span> <span class="hljs-keyword">return</span> eg <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hints.sort</span><span class="hljs-params">(sample,score,    test,train,evals)</span></span>
  sample = Sample.new(the.file)
  train,test = {}, {}
  <span class="hljs-keyword">for</span> i,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(shuffle(sample.egs)) <span class="hljs-keyword">do</span>
     push(i&lt;= the.train*#sample.egs <span class="hljs-keyword">and</span> train <span class="hljs-keyword">or</span> test, eg) <span class="hljs-keyword">end</span>
  evals,train = hints.recurse(sample, train,<span class="hljs-number">0</span>,
                        score <span class="hljs-keyword">or</span> hints.default, {}, (#train)^the.small)
  <span class="hljs-keyword">return</span> evals,sample:clone(train), sample:clone(test) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hints.recurse</span><span class="hljs-params">(sample, egs, evals, scorefun, out, small, worker)</span></span>
  <span class="hljs-keyword">if</span> #egs &lt; small <span class="hljs-keyword">then</span> 
    <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, #egs <span class="hljs-keyword">do</span> push(out, pop(egs)) <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> evals,out 
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> scoreds = {}   
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">worker</span><span class="hljs-params">(eg)</span></span> <span class="hljs-keyword">return</span> hints.locate(scoreds,eg,sample) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">1</span>,the.hints <span class="hljs-keyword">do</span> evals=evals+<span class="hljs-number">1</span>; 
                       push(scoreds, scorefun(pop(egs))) <span class="hljs-keyword">end</span>
  scoreds = betters(scoreds, sample)
  egs     = lap(<span class="hljs-built_in">sort</span>(lap(egs, worker),firsts),second)
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,#egs//<span class="hljs-number">2</span> <span class="hljs-keyword">do</span> push(out, pop(egs)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> hints.recurse(sample, egs,evals, scorefun, out, small)  
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hints.locate</span><span class="hljs-params">(scoreds,eg,sample,        closest,rank,tmp)</span></span>
  closest, rank, tmp = <span class="hljs-number">1E32</span>, <span class="hljs-number">1E32</span>, <span class="hljs-literal">nil</span>
  <span class="hljs-keyword">for</span> rank0, scored <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(scoreds) <span class="hljs-keyword">do</span>
    tmp = dist(eg, scored, sample)
    <span class="hljs-keyword">if</span> tmp &lt; closest <span class="hljs-keyword">then</span> closest,rank = tmp,rank0 <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> {rank+closest/<span class="hljs-number">10</span>^<span class="hljs-number">6</span>, eg} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> eg,fail,example={},<span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">example</span><span class="hljs-params">(k,      f,ok,msg)</span></span>
  f= eg[k]; <span class="hljs-built_in">assert</span>(f,<span class="hljs-string">&quot;unknown action &quot;</span>..k)
  the=cli(options)
  <span class="hljs-keyword">if</span> the.wild <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> f() <span class="hljs-keyword">end</span>
  ok,msg = <span class="hljs-built_in">pcall</span>(f)
  <span class="hljs-keyword">if</span> ok <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(green(<span class="hljs-string">&quot;PASS&quot;</span>),k) 
  <span class="hljs-keyword">else</span>       <span class="hljs-built_in">print</span>(red(<span class="hljs-string">&quot;FAIL&quot;</span>),  k,msg); fail=fail+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.lap</span><span class="hljs-params">()</span></span> 
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">3</span>==lap({<span class="hljs-number">1</span>,<span class="hljs-number">2</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>)[<span class="hljs-number">2</span>]) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.map</span><span class="hljs-params">()</span></span> 
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">3</span>==map({<span class="hljs-number">1</span>,<span class="hljs-number">2</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_,x)</span></span> <span class="hljs-keyword">return</span> x+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>)[<span class="hljs-number">2</span>]) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.tables</span><span class="hljs-params">()</span></span> 
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">20</span>==<span class="hljs-built_in">sort</span>(shuffle({{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>},{<span class="hljs-number">30</span>,<span class="hljs-number">40</span>},{<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}}),firsts)[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.csv</span><span class="hljs-params">(   n,z)</span></span>
  n=<span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> eg <span class="hljs-keyword">in</span> csv(the.file) <span class="hljs-keyword">do</span> n=n+<span class="hljs-number">1</span>; z=eg <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">assert</span>(n==<span class="hljs-number">399</span> <span class="hljs-keyword">and</span> z[#z]==<span class="hljs-number">50</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.rnds</span><span class="hljs-params">(    t)</span></span>
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">10.2</span> == first(rnds({<span class="hljs-number">10.22</span>,<span class="hljs-number">81.22</span>,<span class="hljs-number">22.33</span>},<span class="hljs-number">1</span>))) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.sym</span><span class="hljs-params">(    s)</span></span>
  s=Sym{<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>}
  <span class="hljs-built_in">assert</span>(<span class="hljs-string">&quot;a&quot;</span>==s.mode) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.num1</span><span class="hljs-params">(    n)</span></span>
  n=Num{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">.375</span> == n:norm(<span class="hljs-number">25</span>))
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">15.625</span> == n:sd()) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.num2</span><span class="hljs-params">(    n1,n2,n3,n4)</span></span>
  n1=Num{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  n2=Num{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  <span class="hljs-built_in">assert</span>(n1:mergeable(n2)~=<span class="hljs-literal">nil</span>) 
  n3=Num{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  n4=Num{<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">300</span>,<span class="hljs-number">400</span>,<span class="hljs-number">500</span>,<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">300</span>,<span class="hljs-number">400</span>,<span class="hljs-number">500</span>,<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">300</span>,<span class="hljs-number">400</span>,<span class="hljs-number">500</span>}
  <span class="hljs-built_in">assert</span>(n3:mergeable(n4)==<span class="hljs-literal">nil</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.sample</span><span class="hljs-params">(    s,tmp,d1,d2,n)</span></span>
  s=Sample(the.file) 
  <span class="hljs-built_in">assert</span>(<span class="hljs-number">2110</span> == last(s.egs)[s.all[<span class="hljs-number">3</span>].col])
  <span class="hljs-keyword">local</span> sort1= betters(s.egs,s)
  <span class="hljs-keyword">local</span> lo, hi = s:clone(), s:clone()
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">20</span>                <span class="hljs-keyword">do</span> lo:add(sort1[i]) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> i=#sort1,#sort1<span class="hljs-number">-30</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> hi:add(sort1[i]) <span class="hljs-keyword">end</span>
  shout(s:stats())
  shout(lo:stats())
  shout(hi:stats())
  <span class="hljs-keyword">for</span> m,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sort1) <span class="hljs-keyword">do</span>
    n = bchop(sort1, eg,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> better(a,b,s) <span class="hljs-keyword">end</span>)
    <span class="hljs-built_in">assert</span>(m-n &lt;=<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <p>tmp = sort(map(shuffle(s.egs), 
                 function(_,eg2) return {dist(eg2,s.egs[1],s), eg2} end),
           firsts) 
d1=dist(tmp[1][2], tmp[10][2], s)
d2=dist(tmp[1][2], tmp[#tmp][2], s)
assert(d1*10&lt;d2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eg.hints</span><span class="hljs-params">(    s,_,__,evals,sort1)</span></span>
  s=Sample(the.file) 
  sort1= betters(s.egs,s)
  <span class="hljs-keyword">for</span> _,eg <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sort1) <span class="hljs-keyword">do</span> lap(s.ys, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col)</span></span> <span class="hljs-keyword">return</span> eg[col.col] <span class="hljs-keyword">end</span> ) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-63">&#x00a7;</a>
              </div>
              <p>assert(s.ys[4].lo==1613) 
evals, train,__ = hints.sort(s) 
print(“=”,evals) 
for m,eg in pairs(sort1) do
  n = bchop(sort1, eg,function(a,b) return better(a,b,s) end)
  print(m,n) end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">if</span> the.todo==<span class="hljs-string">&quot;all&quot;</span> <span class="hljs-keyword">then</span> lap(keys(eg),example) <span class="hljs-keyword">else</span> example(the.todo) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-64">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-65">&#x00a7;</a>
              </div>
              <p>trick for checking for rogues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?rogue: &quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(fail)</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-66">&#x00a7;</a>
              </div>
              <p>[[</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>needs stats on samples

teaching:
- sample is v.useful</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-67">&#x00a7;</a>
              </div>
              <p>]]</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
